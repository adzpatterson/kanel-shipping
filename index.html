<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kanel Shipping Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0c;--surface:#141418;--surface-2:#1c1c22;--border:#2a2a32;--text:#e8e8ec;--text-muted:#8b8b96;--accent:#d4a853;--accent-dim:#d4a85320;--red:#e54d4d;--red-bg:#e54d4d15;--orange:#e8923a;--orange-bg:#e8923a15;--blue:#4d9ee5;--blue-bg:#4d9ee515;--green:#4dc77a;--green-bg:#4dc77a15;--gray:#555;--gray-bg:#55555515;--radius:10px;--font:'DM Sans',-apple-system,sans-serif;--mono:'JetBrains Mono',monospace}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
.header{display:flex;align-items:center;justify-content:space-between;padding:20px 32px;border-bottom:1px solid var(--border);background:var(--surface)}
.header-left{display:flex;align-items:center;gap:16px}.header-right{display:flex;align-items:center;gap:12px}
.logo{font-size:24px;font-weight:700;color:var(--accent);letter-spacing:-0.5px}.logo-sub{font-size:12px;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase}
.last-updated{font-size:12px;color:var(--text-muted);font-family:var(--mono)}
.refresh-btn{display:flex;align-items:center;gap:6px;padding:8px 16px;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-family:var(--font);font-size:13px;transition:all .15s}
.refresh-btn:hover{border-color:var(--accent);color:var(--accent)}.refresh-btn svg{width:16px;height:16px}
.nav{display:flex;gap:2px;padding:0 32px;background:var(--surface);border-bottom:1px solid var(--border);overflow-x:auto}
.nav-tab{padding:12px 20px;font-size:13px;font-weight:500;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all .15s}
.nav-tab:hover{color:var(--text)}.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.main{padding:24px 32px}.hidden{display:none!important}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.card-label{font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);margin-bottom:4px}
.card-value{font-size:22px;font-weight:700;font-family:var(--mono)}
.card-sub{font-size:11px;color:var(--text-muted);margin-top:2px;font-family:var(--mono)}
.card-value.red{color:var(--red)}.card-value.orange{color:var(--orange)}.card-value.blue{color:var(--blue)}.card-value.green{color:var(--green)}.card-value.gray{color:var(--gray)}
.filters{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;align-items:center}
.filter-btn{padding:6px 14px;background:transparent;border:1px solid var(--border);border-radius:20px;color:var(--text-muted);cursor:pointer;font-family:var(--font);font-size:12px;transition:all .15s}
.filter-btn:hover{border-color:var(--text);color:var(--text)}.filter-btn.active{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.filter-btn .count{margin-left:6px;font-family:var(--mono);font-size:11px;opacity:.7}
.search-input{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 14px;color:var(--text);font-family:var(--font);font-size:13px;width:220px;outline:none}
.search-input:focus{border-color:var(--accent)}
select.hs{background:var(--surface-2);color:var(--text);border:1px solid var(--border);padding:4px 8px;border-radius:6px;font-family:var(--font);font-size:13px}
.export-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.export-btn{padding:6px 14px;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-family:var(--font);font-size:12px}
.export-btn:hover{border-color:var(--accent);color:var(--accent)}
.result-count{font-size:12px;color:var(--text-muted);font-family:var(--mono)}
.table-wrap{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.table-scroll{overflow-x:auto;max-height:70vh;overflow-y:auto}
table{width:100%;border-collapse:collapse}
thead{position:sticky;top:0;z-index:2}
thead th{padding:10px 14px;text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);background:var(--surface-2);border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none}
thead th:hover{color:var(--text)}
tbody td{padding:10px 14px;border-bottom:1px solid var(--border);white-space:nowrap}
tbody tr:hover{background:var(--surface-2)}
.num{font-family:var(--mono);text-align:right}
.badge{display:inline-block;padding:2px 10px;border-radius:12px;font-size:11px;font-weight:600;letter-spacing:.3px}
.badge-critical{background:var(--red-bg);color:var(--red);border:1px solid #e54d4d40}
.badge-atrisk{background:var(--orange-bg);color:var(--orange);border:1px solid #e8923a40}
.badge-healthy{background:var(--blue-bg);color:var(--blue);border:1px solid #4d9ee540}
.badge-excess{background:var(--green-bg);color:var(--green);border:1px solid #4dc77a40}
.section-header{font-size:14px;font-weight:600;color:var(--accent);padding:20px 0 12px;border-bottom:1px solid var(--border);margin-bottom:16px}
/* Chart containers */
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.chart-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.chart-box h3{font-size:13px;color:var(--accent);margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px}
.bar-chart{display:flex;flex-direction:column;gap:6px}
.bar-row{display:flex;align-items:center;gap:8px;font-size:12px}
.bar-label{width:80px;text-align:right;color:var(--text-muted);font-family:var(--mono);font-size:11px;flex-shrink:0}
.bar-track{flex:1;height:20px;background:var(--surface-2);border-radius:4px;overflow:hidden;position:relative}
.bar-fill{height:100%;border-radius:4px;transition:width .4s;display:flex;align-items:center;justify-content:flex-end;padding-right:6px;font-size:10px;font-family:var(--mono);color:#fff;min-width:fit-content}
.bar-val{margin-left:8px;font-family:var(--mono);font-size:11px;width:60px;flex-shrink:0}
/* Benchmark indicator */
.benchmark{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:12px}
.benchmark-dot{width:10px;height:10px;border-radius:50%}
.benchmark-label{font-size:12px;color:var(--text-muted)}
.benchmark-value{font-size:14px;font-weight:600;font-family:var(--mono)}
/* Setup screen */
.setup-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:16px;padding:32px}
.setup-screen h2{font-size:28px;color:var(--accent)}.setup-screen p{color:var(--text-muted);text-align:center;max-width:400px}
.setup-screen label{font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}
.setup-screen input{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px;color:var(--text);font-family:var(--mono);font-size:14px;width:320px;text-align:center}
.setup-btn{padding:10px 32px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;font-weight:600;cursor:pointer;font-family:var(--font);font-size:14px}
.setup-error{color:var(--red);font-size:13px;display:none;text-align:center}
.loading-spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:768px){.header{padding:16px}.nav{padding:0 16px}.main{padding:16px}.cards{grid-template-columns:repeat(2,1fr)}.chart-row{grid-template-columns:1fr}.search-input{width:100%}}
</style>
</head>
<body>

<!-- SETUP -->
<div id="setupScreen" class="setup-screen">
<h2>Kanel Shipping Dashboard</h2>
<p>Make sure the shipping proxy is running.<br><code style="background:var(--bg);padding:2px 6px;border-radius:4px;font-family:var(--mono)">node proxy.js</code></p>
<label>Proxy URL</label>
<input type="text" id="setupUrl" value="http://localhost:3848">
<label style="margin-top:8px">Data Since (YYYY-MM-DD)</label>
<input type="text" id="setupSince" value="2025-09-01">
<button class="setup-btn" onclick="saveConfig()">Connect</button>
<div id="setupError" class="setup-error"></div>
</div>

<!-- APP -->
<div id="app" class="hidden">
<div class="header">
<div class="header-left"><div><div class="logo">Kanel</div><div class="logo-sub">Shipping Dashboard</div></div></div>
<div class="header-right">
<span class="last-updated" id="lastUpdated"></span>
<button class="refresh-btn" onclick="exportAllXLSX()" style="background:transparent;border:1px solid var(--border);margin-right:8px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" style="width:16px;height:16px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button>
<button class="refresh-btn" id="refreshBtn" onclick="refreshData()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>Refresh</button>
</div></div>

<div class="nav">
<div class="nav-tab active" data-tab="overview" onclick="switchTab('overview')">Overview</div>
<div class="nav-tab" data-tab="monthly" onclick="switchTab('monthly')">Monthly Trends</div>
<div class="nav-tab" data-tab="geography" onclick="switchTab('geography')">Geographic</div>
<div class="nav-tab" data-tab="carriers" onclick="switchTab('carriers')">Carriers & Services</div>
<div class="nav-tab" data-tab="shipments" onclick="switchTab('shipments')">All Shipments</div>
<div class="nav-tab" data-tab="guide" onclick="switchTab('guide')">How It Works</div>
</div>

<div class="main">

<!-- OVERVIEW -->
<div id="tab-overview" class="tab-content">
<div class="cards" id="overviewCards"></div>
<div id="overviewBenchmarks"></div>
<div class="chart-row" id="overviewCharts"></div>
<div class="section-header">Top Savings Opportunities</div>
<div id="overviewSavings"></div>
</div>

<!-- MONTHLY TRENDS -->
<div id="tab-monthly" class="tab-content hidden">
<div class="cards" id="monthlyCards"></div>
<div class="export-bar"><span class="result-count" id="monthlyCount"></span><button class="export-btn" onclick="xcsv('monthly')">Export CSV</button></div>
<div class="table-wrap"><div class="table-scroll"><table><thead id="monthlyHead"></thead><tbody id="monthlyBody"></tbody></table></div></div>
</div>

<!-- GEOGRAPHIC -->
<div id="tab-geography" class="tab-content hidden">
<div class="cards" id="geoCards"></div>
<div class="chart-row" id="geoCharts"></div>
<div class="export-bar"><span class="result-count" id="geoCount"></span><button class="export-btn" onclick="xcsv('geography')">Export CSV</button></div>
<div class="table-wrap"><div class="table-scroll"><table><thead id="geoHead"></thead><tbody id="geoBody"></tbody></table></div></div>
</div>

<!-- CARRIERS & SERVICES -->
<div id="tab-carriers" class="tab-content hidden">
<div class="cards" id="carrierCards"></div>
<div class="chart-row" id="carrierCharts"></div>
<div class="export-bar"><span class="result-count" id="carrierCount"></span><button class="export-btn" onclick="xcsv('carriers')">Export CSV</button></div>
<div class="table-wrap"><div class="table-scroll"><table><thead id="carrierHead"></thead><tbody id="carrierBody"></tbody></table></div></div>
</div>

<!-- ALL SHIPMENTS -->
<div id="tab-shipments" class="tab-content hidden">
<div class="filters" id="shipFilters"></div>
<div class="export-bar"><span class="result-count" id="shipCount"></span><button class="export-btn" onclick="xcsv('shipments')">Export CSV</button></div>
<div class="table-wrap"><div class="table-scroll"><table><thead id="shipHead"></thead><tbody id="shipBody"></tbody></table></div></div>
</div>

<!-- HOW IT WORKS -->
<div id="tab-guide" class="tab-content hidden">
<div style="max-width:860px;line-height:1.8;color:var(--text)">
<div style="margin-bottom:32px">
<h2 style="color:var(--accent);font-size:20px;margin-bottom:8px">How This Dashboard Works</h2>
<p style="color:var(--text-muted)">This dashboard pulls shipment data from OrderCup (label costs, carriers, weights, destinations) and combines it with Shopify order data (revenue, shipping charged) to analyze DTC shipping performance against industry benchmarks.</p>
</div>
<div style="margin-bottom:32px">
<h3 style="color:var(--accent);font-size:16px;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:12px">Data Sources</h3>
<p style="margin:8px 0"><span style="color:var(--blue);font-weight:600">OrderCup</span> - Every shipment label purchased. Contains carrier, service level, actual weight, billed weight, label cost, destination province/state, and tracking. This is the source of truth for what we actually pay to ship.</p>
<p style="margin:8px 0"><span style="color:var(--blue);font-weight:600">Shopify</span> - Order revenue and what we charged the customer for shipping. Combined with OrderCup to calculate the gap between what we charge and what we pay.</p>
<p style="margin:8px 0"><span style="color:var(--blue);font-weight:600">Fishbowl</span> - Customer and channel classification. Used to tag shipments as DTC, Wholesale, Corporate, or Grocery.</p>
</div>
<div style="margin-bottom:32px">
<h3 style="color:var(--accent);font-size:16px;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:12px">Key Metrics</h3>
<p style="margin:4px 0 4px 16px"><span style="color:var(--accent)">Shipping Cost %</span> - Label cost / order revenue. Industry benchmark: 8-12%. Below 8% is excellent. Above 14% needs attention.</p>
<p style="margin:4px 0 4px 16px"><span style="color:var(--accent)">Avg Label Cost</span> - What each shipment costs us. Affected by weight, distance, and service level.</p>
<p style="margin:4px 0 4px 16px"><span style="color:var(--accent)">Free Shipping Rate</span> - % of orders where customer paid $0 for shipping. Industry norm: 60-75%. Over 80% means we are absorbing too much.</p>
<p style="margin:4px 0 4px 16px"><span style="color:var(--accent)">Shipping Recovery</span> - What we charge customers / what we pay. Shows how much of our shipping cost we recoup.</p>
<p style="margin:4px 0 4px 16px"><span style="color:var(--accent)">Volumetric %</span> - % of shipments billed on dimensional weight (box size) rather than actual weight. High % means boxes are too big.</p>
</div>
<div style="margin-bottom:32px;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius)">
<h3 style="color:var(--accent);font-size:16px;margin-bottom:12px">Industry Benchmarks (DTC Food/CPG)</h3>
<p style="margin:4px 0 4px 16px">Shipping cost %: 8-12% of revenue</p>
<p style="margin:4px 0 4px 16px">Avg label cost: $8-14 per shipment</p>
<p style="margin:4px 0 4px 16px">AOV: $80-120</p>
<p style="margin:4px 0 4px 16px">Shipping charged per order: $5-8</p>
<p style="margin:4px 0 4px 16px">Free shipping rate: 60-75%</p>
</div>
</div></div>

</div></div>

<script>
// ======== STATE ========
let S={config:null,raw:null,processed:null,shipQ:'',sortC:{},sortD:{},_c:{}};

// ======== UTILS ========
function fmt(n,d=0){if(n===null||n===undefined||isNaN(n))return'--';return Number(n).toLocaleString('en-CA',{minimumFractionDigits:d,maximumFractionDigits:d});}
function fmtD(n){return'$'+fmt(n,2);}
function fmtPct(n){return fmt(n,1)+'%';}
function fmtDate(s){if(!s)return'--';const d=new Date(s);if(isNaN(d))return'--';return d.toLocaleDateString('en-CA',{month:'short',day:'numeric',year:'numeric'});}

// Province/state normalization
const PROV_MAP={'QC':'QC','Quebec':'QC','ON':'ON','Ontario':'ON','BC':'BC','British Columbia':'BC',
  'AB':'AB','Alberta':'AB','MB':'MB','Manitoba':'MB','SK':'SK','Saskatchewan':'SK',
  'NS':'NS','Nova Scotia':'NS','NB':'NB','New Brunswick':'NB','NL':'NL','Newfoundland':'NL',
  'PE':'PE','PEI':'PE','Prince Edward Island':'PE','NT':'NT','NU':'NU','YT':'YT'};
function normProv(s){if(!s)return'Unknown';const t=s.trim();return PROV_MAP[t]||t;}

// Region grouping
function getRegion(prov){
  const p=normProv(prov);
  if(p==='QC')return'Quebec';
  if(p==='ON')return'Ontario';
  if(['BC','AB','SK','MB'].includes(p))return'Western Canada';
  if(['NS','NB','NL','PE'].includes(p))return'Atlantic';
  if(['NT','NU','YT'].includes(p))return'Northern';
  return'Other';
}

// Month key from date string
function monthKey(dateStr){
  if(!dateStr)return'Unknown';
  const d=new Date(dateStr);
  if(isNaN(d))return'Unknown';
  return d.toLocaleDateString('en-CA',{month:'short',year:'numeric'});
}

// ======== NAV ========
function switchTab(t){
  document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));
  document.querySelectorAll('.nav-tab').forEach(e=>e.classList.remove('active'));
  document.getElementById('tab-'+t).classList.remove('hidden');
  document.querySelector(`.nav-tab[data-tab="${t}"]`).classList.add('active');
}

// ======== PROCESS DATA ========
function processShipments(raw){
  const shipments=raw.shipments||[];

  // Normalize each shipment
  const processed=shipments.map(s=>{
    const cost=parseFloat(s.shipping_price)||parseFloat(s.cost)||parseFloat(s.label_cost)||0;
    const actualWt=parseFloat(s.actual_weight)||parseFloat(s.weight)||0;
    const billedWt=(()=>{
      const l=parseFloat(s.length)||0,w=parseFloat(s.width)||0,h=parseFloat(s.height)||0;
      if(l&&w&&h){const vol=(l*w*h)/5000; return Math.max(vol,actualWt);}
      return parseFloat(s.billed_weight)||actualWt;
    })();
    const isVolumetric=billedWt>actualWt&&actualWt>0;
    const carrier=s.carrier||s.carrier_name||'Unknown';
    const service=s.service||s.service_name||s.shipping_method||'Unknown';
    const addr=s.ship_to_address||{};
    const prov=normProv(addr.state||s.ship_to_state||s.to_state||'');
    const city=addr.city||s.ship_to_city||s.to_city||'';
    const postal=addr.post_code||s.ship_to_zip||s.to_zip||'';
    const region=getRegion(prov);
    const shipDate=s.ship_date||s.created_at||s.date||'';
    const month=monthKey(shipDate);
    const orderNum=s.order_id||s.order_number||s.reference||'';

    return{
      id:s.id||s.shipment_id||'',
      orderNum,
      shipDate,
      month,
      carrier,
      service,
      cost,
      actualWt,
      billedWt,
      isVolumetric,
      prov,
      region,
      city:city,
      postalCode:s.ship_to_zip||s.to_zip||'',
      trackingNum:s.tracking_id||s.tracking_number||s.tracking||'',
      packageType:s.package_type||'',
      rsm:s.rsm||'',
      itemCount:parseInt(s.item_count)||0,
      length:parseFloat(s.length)||0,
      width:parseFloat(s.width)||0,
      height:parseFloat(s.height)||0,
    };
  }).filter(s=>s.cost>0); // Only shipments with actual cost

  // Sort by date
  processed.sort((a,b)=>(a.shipDate||'').localeCompare(b.shipDate||''));

  // Get unique months in order
  const monthSet=new Set();
  processed.forEach(s=>monthSet.add(s.month));
  const months=[...monthSet].sort((a,b)=>new Date(a+' 1')-new Date(b+' 1'));

  // Monthly aggregation
  const byMonth={};
  processed.forEach(s=>{
    if(!byMonth[s.month])byMonth[s.month]={month:s.month,shipments:0,totalCost:0,totalActualWt:0,totalBilledWt:0,volumetricCount:0};
    const m=byMonth[s.month];
    m.shipments++;m.totalCost+=s.cost;m.totalActualWt+=s.actualWt;m.totalBilledWt+=s.billedWt;
    if(s.isVolumetric)m.volumetricCount++;
  });
  const monthlyData=months.map(m=>{
    const d=byMonth[m];
    d.avgCost=d.shipments>0?d.totalCost/d.shipments:0;
    d.avgWt=d.shipments>0?d.totalActualWt/d.shipments:0;
    d.volPct=d.shipments>0?d.volumetricCount/d.shipments*100:0;
    return d;
  });

  // Geographic aggregation
  const byProv={};
  processed.forEach(s=>{
    if(!byProv[s.prov])byProv[s.prov]={prov:s.prov,region:s.region,shipments:0,totalCost:0};
    byProv[s.prov].shipments++;byProv[s.prov].totalCost+=s.cost;
  });
  const geoData=Object.values(byProv).sort((a,b)=>b.shipments-a.shipments).map(g=>{
    g.avgCost=g.shipments>0?g.totalCost/g.shipments:0;
    g.pctOfTotal=processed.length>0?g.shipments/processed.length*100:0;
    return g;
  });

  // Carrier aggregation
  const byCarrier={};
  processed.forEach(s=>{
    const key=s.carrier+' | '+s.service;
    if(!byCarrier[key])byCarrier[key]={carrier:s.carrier,service:s.service,shipments:0,totalCost:0,totalWt:0};
    byCarrier[key].shipments++;byCarrier[key].totalCost+=s.cost;byCarrier[key].totalWt+=s.actualWt;
  });
  const carrierData=Object.values(byCarrier).sort((a,b)=>b.shipments-a.shipments).map(c=>{
    c.avgCost=c.shipments>0?c.totalCost/c.shipments:0;
    c.avgWt=c.shipments>0?c.totalWt/c.shipments:0;
    c.pctOfTotal=processed.length>0?c.shipments/processed.length*100:0;
    return c;
  });

  // Totals
  const totalCost=processed.reduce((s,r)=>s+r.cost,0);
  const totalShipments=processed.length;
  const avgCost=totalShipments>0?totalCost/totalShipments:0;
  const volCount=processed.filter(s=>s.isVolumetric).length;
  const volPct=totalShipments>0?volCount/totalShipments*100:0;
  const avgActualWt=totalShipments>0?processed.reduce((s,r)=>s+r.actualWt,0)/totalShipments:0;
  const avgBilledWt=totalShipments>0?processed.reduce((s,r)=>s+r.billedWt,0)/totalShipments:0;

  return{
    shipments:processed,
    months,
    monthlyData,
    geoData,
    carrierData,
    totals:{totalCost,totalShipments,avgCost,volCount,volPct,avgActualWt,avgBilledWt},
  };
}

// ======== RENDER: OVERVIEW ========
function rOverview(){
  const t=S.processed.totals;
  const md=S.processed.monthlyData;

  document.getElementById('overviewCards').innerHTML=`
    <div class="card"><div class="card-label">Total Shipments</div><div class="card-value">${fmt(t.totalShipments)}</div><div class="card-sub">${S.processed.months[0]} to ${S.processed.months[S.processed.months.length-1]}</div></div>
    <div class="card"><div class="card-label">Total Label Cost</div><div class="card-value">${fmtD(t.totalCost)}</div></div>
    <div class="card"><div class="card-label">Avg Cost / Shipment</div><div class="card-value ${t.avgCost>14?'red':t.avgCost>12?'orange':'green'}">${fmtD(t.avgCost)}</div><div class="card-sub">Benchmark: $8-14</div></div>
    <div class="card"><div class="card-label">Volumetric Billing</div><div class="card-value ${t.volPct>40?'orange':'blue'}">${fmtPct(t.volPct)}</div><div class="card-sub">${fmt(t.volCount)} of ${fmt(t.totalShipments)}</div></div>
    <div class="card"><div class="card-label">Avg Actual Weight</div><div class="card-value">${fmt(t.avgActualWt,2)}</div><div class="card-sub">kg per shipment</div></div>
    <div class="card"><div class="card-label">Avg Billed Weight</div><div class="card-value ${t.avgBilledWt>t.avgActualWt*1.2?'orange':'blue'}">${fmt(t.avgBilledWt,2)}</div><div class="card-sub">kg (dim weight impact)</div></div>`;

  // Benchmarks
  document.getElementById('overviewBenchmarks').innerHTML=`
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px">
      <div class="benchmark"><div class="benchmark-dot" style="background:${t.avgCost<=14?'var(--green)':'var(--red)'}"></div>
        <span class="benchmark-label">Avg Label Cost</span><span class="benchmark-value">${fmtD(t.avgCost)}</span>
        <span class="benchmark-label">vs $8-14 benchmark</span></div>
      <div class="benchmark"><div class="benchmark-dot" style="background:${t.volPct<40?'var(--green)':'var(--orange)'}"></div>
        <span class="benchmark-label">Volumetric %</span><span class="benchmark-value">${fmtPct(t.volPct)}</span>
        <span class="benchmark-label">billed on dim weight</span></div>
    </div>`;

  // Charts: Monthly cost trend + Province distribution
  const maxMoCost=Math.max(...md.map(m=>m.totalCost),1);
  const geo=S.processed.geoData.slice(0,8);
  const maxGeo=Math.max(...geo.map(g=>g.shipments),1);

  document.getElementById('overviewCharts').innerHTML=`
    <div class="chart-box"><h3>Monthly Label Cost</h3><div class="bar-chart">
      ${md.map(m=>`<div class="bar-row"><div class="bar-label">${m.month.substring(0,3)}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${m.totalCost/maxMoCost*100}%;background:var(--accent)">${fmtD(m.totalCost)}</div></div>
        <div class="bar-val">${fmt(m.shipments)} shp</div></div>`).join('')}
    </div></div>
    <div class="chart-box"><h3>Top Destinations</h3><div class="bar-chart">
      ${geo.map(g=>`<div class="bar-row"><div class="bar-label">${g.prov}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${g.shipments/maxGeo*100}%;background:var(--blue)">${fmt(g.shipments)}</div></div>
        <div class="bar-val">${fmtPct(g.pctOfTotal)}</div></div>`).join('')}
    </div></div>`;

  // Savings opportunities
  const volSavings=t.volCount*2; // Rough estimate: $2 per volumetric-billed shipment
  document.getElementById('overviewSavings').innerHTML=`
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:12px">
      <div class="card" style="border-color:var(--orange)"><div class="card-label">Box Right-Sizing</div>
        <div class="card-value orange">~${fmtD(volSavings*12/S.processed.months.length)}/yr</div>
        <div class="card-sub">${fmt(t.volCount)} shipments billed on volumetric weight. Smaller boxes = actual weight billing.</div></div>
      <div class="card" style="border-color:var(--blue)"><div class="card-label">Service Level Optimization</div>
        <div class="card-value blue">TBD</div>
        <div class="card-sub">Analyze Regular Parcel vs Expedited for non-urgent repeat orders.</div></div>
      <div class="card" style="border-color:var(--green)"><div class="card-label">Volume Discount Negotiation</div>
        <div class="card-value green">${fmt(t.totalShipments*12/S.processed.months.length)} shp/yr</div>
        <div class="card-sub">Annual volume supports carrier negotiation.</div></div>
    </div>`;
}

// ======== RENDER: MONTHLY ========
function rMonthly(){
  const md=S.processed.monthlyData;S._c.monthlyF=md;
  const totalCost=md.reduce((s,m)=>s+m.totalCost,0);
  const totalShip=md.reduce((s,m)=>s+m.shipments,0);

  document.getElementById('monthlyCards').innerHTML=`
    <div class="card"><div class="card-label">Months</div><div class="card-value">${md.length}</div></div>
    <div class="card"><div class="card-label">Avg Monthly Cost</div><div class="card-value">${fmtD(totalCost/md.length)}</div></div>
    <div class="card"><div class="card-label">Avg Monthly Shipments</div><div class="card-value">${fmt(totalShip/md.length)}</div></div>
    <div class="card"><div class="card-label">Peak Month</div><div class="card-value" style="font-size:14px">${md.reduce((max,m)=>m.shipments>max.shipments?m:max,{shipments:0}).month||'--'}</div></div>`;

  document.getElementById('monthlyHead').innerHTML=`<tr>
    <th>Month</th><th>Shipments</th><th>Total Cost</th><th>Avg Cost</th><th>Avg Weight (kg)</th><th>Volumetric %</th></tr>`;
  document.getElementById('monthlyCount').textContent=`${md.length} months`;
  document.getElementById('monthlyBody').innerHTML=md.map(m=>`<tr>
    <td style="font-weight:600">${m.month}</td>
    <td class="num">${fmt(m.shipments)}</td>
    <td class="num" style="font-weight:600">${fmtD(m.totalCost)}</td>
    <td class="num" style="color:${m.avgCost>14?'var(--red)':m.avgCost>12?'var(--orange)':'var(--green)'}">${fmtD(m.avgCost)}</td>
    <td class="num">${fmt(m.avgWt,2)}</td>
    <td class="num" style="color:${m.volPct>40?'var(--orange)':'var(--text-muted)'}">${fmtPct(m.volPct)}</td>
  </tr>`).join('');
}

// ======== RENDER: GEOGRAPHIC ========
function rGeo(){
  const geo=S.processed.geoData;S._c.geoF=geo;

  // Region rollup
  const byRegion={};geo.forEach(g=>{
    if(!byRegion[g.region])byRegion[g.region]={region:g.region,shipments:0,totalCost:0};
    byRegion[g.region].shipments+=g.shipments;byRegion[g.region].totalCost+=g.totalCost;
  });
  const regions=Object.values(byRegion).sort((a,b)=>b.shipments-a.shipments);

  document.getElementById('geoCards').innerHTML=`
    <div class="card"><div class="card-label">Provinces/States</div><div class="card-value">${geo.length}</div></div>
    <div class="card"><div class="card-label">Top Province</div><div class="card-value" style="font-size:16px">${geo[0]?geo[0].prov+' ('+fmtPct(geo[0].pctOfTotal)+')':'--'}</div></div>
    <div class="card"><div class="card-label">Regions</div><div class="card-value">${regions.length}</div></div>`;

  // Region bar chart
  const maxR=Math.max(...regions.map(r=>r.shipments),1);
  document.getElementById('geoCharts').innerHTML=`
    <div class="chart-box"><h3>By Region</h3><div class="bar-chart">
      ${regions.map(r=>`<div class="bar-row"><div class="bar-label" style="width:120px">${r.region}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${r.shipments/maxR*100}%;background:var(--blue)">${fmt(r.shipments)}</div></div>
        <div class="bar-val">${fmtD(r.totalCost/r.shipments)}/shp</div></div>`).join('')}
    </div></div>
    <div class="chart-box"><h3>Cost by Region</h3><div class="bar-chart">
      ${regions.map(r=>{const avgC=r.totalCost/r.shipments;return`<div class="bar-row"><div class="bar-label" style="width:120px">${r.region}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${avgC/20*100}%;background:${avgC>15?'var(--red)':avgC>12?'var(--orange)':'var(--green)'}">${fmtD(avgC)}</div></div>
        <div class="bar-val">${fmtD(r.totalCost)}</div></div>`;}).join('')}
    </div></div>`;

  document.getElementById('geoHead').innerHTML=`<tr><th>Province/State</th><th>Region</th><th>Shipments</th><th>% of Total</th><th>Total Cost</th><th>Avg Cost</th></tr>`;
  document.getElementById('geoCount').textContent=`${geo.length} destinations`;
  document.getElementById('geoBody').innerHTML=geo.map(g=>`<tr>
    <td style="font-weight:600">${g.prov}</td><td style="color:var(--text-muted)">${g.region}</td>
    <td class="num">${fmt(g.shipments)}</td><td class="num">${fmtPct(g.pctOfTotal)}</td>
    <td class="num">${fmtD(g.totalCost)}</td>
    <td class="num" style="color:${g.avgCost>15?'var(--red)':g.avgCost>12?'var(--orange)':'var(--green)'}">${fmtD(g.avgCost)}</td>
  </tr>`).join('');
}

// ======== RENDER: CARRIERS ========
function rCarriers(){
  const cd=S.processed.carrierData;S._c.carriersF=cd;
  const totalCost=cd.reduce((s,c)=>s+c.totalCost,0);

  // Carrier rollup (without service breakdown)
  const byCarrier={};cd.forEach(c=>{
    if(!byCarrier[c.carrier])byCarrier[c.carrier]={carrier:c.carrier,shipments:0,totalCost:0};
    byCarrier[c.carrier].shipments+=c.shipments;byCarrier[c.carrier].totalCost+=c.totalCost;
  });
  const carriers=Object.values(byCarrier).sort((a,b)=>b.shipments-a.shipments);

  document.getElementById('carrierCards').innerHTML=`
    <div class="card"><div class="card-label">Carriers</div><div class="card-value">${carriers.length}</div></div>
    <div class="card"><div class="card-label">Service Levels</div><div class="card-value">${cd.length}</div></div>
    <div class="card"><div class="card-label">Primary Carrier</div><div class="card-value" style="font-size:14px">${carriers[0]?carriers[0].carrier:'--'}</div><div class="card-sub">${carriers[0]?fmtPct(carriers[0].shipments/S.processed.totals.totalShipments*100)+' of volume':''}</div></div>`;

  const maxC=Math.max(...carriers.map(c=>c.shipments),1);
  document.getElementById('carrierCharts').innerHTML=`
    <div class="chart-box"><h3>Volume by Carrier</h3><div class="bar-chart">
      ${carriers.map(c=>`<div class="bar-row"><div class="bar-label" style="width:140px">${c.carrier}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${c.shipments/maxC*100}%;background:var(--accent)">${fmt(c.shipments)}</div></div>
        <div class="bar-val">${fmtD(c.totalCost/c.shipments)}/shp</div></div>`).join('')}
    </div></div>
    <div class="chart-box"><h3>Spend by Carrier</h3><div class="bar-chart">
      ${carriers.map(c=>`<div class="bar-row"><div class="bar-label" style="width:140px">${c.carrier}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${c.totalCost/totalCost*100}%;background:var(--blue)">${fmtD(c.totalCost)}</div></div>
        <div class="bar-val">${fmtPct(c.totalCost/totalCost*100)}</div></div>`).join('')}
    </div></div>`;

  document.getElementById('carrierHead').innerHTML=`<tr><th>Carrier</th><th>Service</th><th>Shipments</th><th>% of Total</th><th>Total Cost</th><th>Avg Cost</th><th>Avg Weight</th></tr>`;
  document.getElementById('carrierCount').textContent=`${cd.length} carrier-service combinations`;
  document.getElementById('carrierBody').innerHTML=cd.map(c=>`<tr>
    <td style="font-weight:600">${c.carrier}</td><td style="color:var(--text-muted)">${c.service}</td>
    <td class="num">${fmt(c.shipments)}</td><td class="num">${fmtPct(c.pctOfTotal)}</td>
    <td class="num">${fmtD(c.totalCost)}</td>
    <td class="num" style="color:${c.avgCost>15?'var(--red)':c.avgCost>12?'var(--orange)':'var(--green)'}">${fmtD(c.avgCost)}</td>
    <td class="num">${fmt(c.avgWt,2)} kg</td>
  </tr>`).join('');
}

// ======== RENDER: ALL SHIPMENTS ========
function rShipments(){
  const all=S.processed.shipments;
  let d=all;
  if(S.shipQ){const q=S.shipQ.toLowerCase();d=d.filter(s=>(s.orderNum+s.carrier+s.service+s.prov+s.city).toLowerCase().includes(q));}
  S._c.shipmentsF=d;

  document.getElementById('shipFilters').innerHTML=`
    <input type="text" class="search-input" placeholder="Search orders, carriers, destinations..." oninput="S.shipQ=this.value;rShipments()" value="${S.shipQ}">
    <span class="result-count" style="margin-left:8px">${fmt(d.length)} shipments</span>`;
  document.getElementById('shipCount').textContent=`${fmt(d.length)} shipments`;

  document.getElementById('shipHead').innerHTML=`<tr>
    <th>Order #</th><th>Ship Date</th><th>Carrier</th><th>Service</th><th>Cost</th>
    <th>Actual Wt</th><th>Billed Wt</th><th>Vol?</th><th>Province</th><th>City</th></tr>`;

  // Show last 500 for performance
  const show=d.slice(-500).reverse();
  document.getElementById('shipBody').innerHTML=show.map(s=>`<tr>
    <td style="font-family:var(--mono);font-size:12px">${s.orderNum}</td>
    <td style="font-size:12px">${fmtDate(s.shipDate)}</td>
    <td>${s.carrier}</td><td style="font-size:12px;color:var(--text-muted)">${s.service}</td>
    <td class="num" style="font-weight:600">${fmtD(s.cost)}</td>
    <td class="num">${fmt(s.actualWt,2)}</td>
    <td class="num" style="color:${s.isVolumetric?'var(--orange)':'var(--text-muted)'}">${fmt(s.billedWt,2)}</td>
    <td style="text-align:center">${s.isVolumetric?'<span style="color:var(--orange)">DIM</span>':''}</td>
    <td>${s.prov}</td><td style="font-size:12px;color:var(--text-muted)">${s.city}</td>
  </tr>`).join('');

  if(d.length>500){
    document.getElementById('shipBody').innerHTML+=`<tr><td colspan="10" style="text-align:center;color:var(--text-muted);padding:16px">Showing last 500 of ${fmt(d.length)} shipments. Export CSV for full data.</td></tr>`;
  }
}

// ======== CSV EXPORT ========
function xcsv(tab){
  let rows=[],fn='';
  if(tab==='monthly'){rows=[['Month','Shipments','Total Cost','Avg Cost','Avg Weight','Volumetric %']];
    (S._c.monthlyF||[]).forEach(m=>rows.push([m.month,m.shipments,m.totalCost.toFixed(2),m.avgCost.toFixed(2),m.avgWt.toFixed(2),m.volPct.toFixed(1)]));fn='Kanel_Shipping_Monthly.csv';
  }else if(tab==='geography'){rows=[['Province','Region','Shipments','% of Total','Total Cost','Avg Cost']];
    (S._c.geoF||[]).forEach(g=>rows.push([g.prov,g.region,g.shipments,g.pctOfTotal.toFixed(1),g.totalCost.toFixed(2),g.avgCost.toFixed(2)]));fn='Kanel_Shipping_Geographic.csv';
  }else if(tab==='carriers'){rows=[['Carrier','Service','Shipments','% of Total','Total Cost','Avg Cost','Avg Weight']];
    (S._c.carriersF||[]).forEach(c=>rows.push([c.carrier,c.service,c.shipments,c.pctOfTotal.toFixed(1),c.totalCost.toFixed(2),c.avgCost.toFixed(2),c.avgWt.toFixed(2)]));fn='Kanel_Shipping_Carriers.csv';
  }else if(tab==='shipments'){rows=[['Order #','Ship Date','Carrier','Service','Cost','Actual Wt','Billed Wt','Volumetric','Province','City','Tracking']];
    (S._c.shipmentsF||S.processed.shipments||[]).forEach(s=>rows.push([s.orderNum,s.shipDate,s.carrier,s.service,s.cost.toFixed(2),s.actualWt,s.billedWt,s.isVolumetric?'Y':'N',s.prov,s.city,s.trackingNum]));fn='Kanel_All_Shipments.csv';
  }
  const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=fn;a.click();
}

// ======== EXPORT ALL XLSX ========
async function exportAllXLSX(){
  if(!window.XLSX){const s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';document.head.appendChild(s);await new Promise(r=>s.onload=r);}
  const wb=XLSX.utils.book_new();
  const mkSheet=(data,name)=>{XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(data),name);};
  mkSheet([['Month','Shipments','Total Cost','Avg Cost','Avg Weight','Volumetric %'],
    ...(S.processed.monthlyData||[]).map(m=>[m.month,m.shipments,m.totalCost,m.avgCost,m.avgWt,m.volPct])],'Monthly');
  mkSheet([['Province','Region','Shipments','% of Total','Total Cost','Avg Cost'],
    ...(S.processed.geoData||[]).map(g=>[g.prov,g.region,g.shipments,g.pctOfTotal,g.totalCost,g.avgCost])],'Geographic');
  mkSheet([['Carrier','Service','Shipments','% of Total','Total Cost','Avg Cost','Avg Weight'],
    ...(S.processed.carrierData||[]).map(c=>[c.carrier,c.service,c.shipments,c.pctOfTotal,c.totalCost,c.avgCost,c.avgWt])],'Carriers');
  mkSheet([['Order #','Ship Date','Carrier','Service','Cost','Actual Wt','Billed Wt','Volumetric','Province','City'],
    ...(S.processed.shipments||[]).map(s=>[s.orderNum,s.shipDate,s.carrier,s.service,s.cost,s.actualWt,s.billedWt,s.isVolumetric?'Y':'N',s.prov,s.city])],'All Shipments');
  XLSX.writeFile(wb,`Kanel_Shipping_Export_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// ======== RENDER ALL ========
function renderAll(){if(!S.processed)return;rOverview();rMonthly();rGeo();rCarriers();rShipments();}

// ======== CONNECTION ========
async function saveConfig(){
  const url=document.getElementById('setupUrl').value.trim().replace(/\/$/,'');
  const since=document.getElementById('setupSince').value.trim();
  const err=document.getElementById('setupError');
  if(!url){err.textContent='URL required';err.style.display='block';return;}
  err.textContent='Connecting...';err.style.display='block';err.style.color='var(--text-muted)';
  try{
    const r=await fetch(`${url}/api/health`);if(!r.ok)throw new Error(`HTTP ${r.status}`);
    const d=await r.json();if(d.status!=='ok')throw new Error('Bad response');
    S.config={url,since:since||'2025-09-01'};
    localStorage.setItem('ks-cfg',JSON.stringify(S.config));
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    refreshData();
  }catch(e){err.style.color='var(--red)';err.textContent=`Failed: ${e.message}. Is the proxy running?`;}
}

async function refreshData(){
  const btn=document.getElementById('refreshBtn');btn.disabled=true;
  btn.innerHTML='<div class="loading-spinner" style="width:16px;height:16px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:6px"></div>Loading...';
  try{
    const r=await fetch(`${S.config.url}/api/shipping-data?since=${S.config.since}`);
    if(!r.ok)throw new Error(`HTTP ${r.status}`);
    S.raw=await r.json();
    S.processed=processShipments(S.raw);
    document.getElementById('lastUpdated').textContent='Updated '+new Date().toLocaleString('en-CA',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
    console.log(`Loaded ${S.processed.totals.totalShipments} shipments, ${S.processed.months.length} months`);
    renderAll();
  }catch(e){alert('Failed to load data: '+e.message);}
  btn.disabled=false;
  btn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>Refresh';
}

function loadConfig(){
  const saved=localStorage.getItem('ks-cfg');
  if(saved){try{
    S.config=JSON.parse(saved);
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    refreshData();
  }catch(e){localStorage.removeItem('ks-cfg');}}
}

loadConfig();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kanel Shipping Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0c;--surface:#141418;--surface-2:#1c1c22;--surface-3:#222228;--border:#2a2a32;--text:#e8e8ec;--text-muted:#8b8b96;--accent:#d4a853;--accent-dim:#d4a85320;--red:#e54d4d;--red-bg:#e54d4d15;--orange:#e8923a;--orange-bg:#e8923a15;--blue:#4d9ee5;--blue-bg:#4d9ee515;--green:#4dc77a;--green-bg:#4dc77a15;--purple:#9b6dff;--purple-bg:#9b6dff15;--teal:#36c5b0;--radius:10px;--font:'DM Sans',-apple-system,sans-serif;--mono:'JetBrains Mono',monospace}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
.header{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;border-bottom:1px solid var(--border);background:var(--surface)}
.header-left{display:flex;align-items:center;gap:14px}.header-right{display:flex;align-items:center;gap:8px}
.logo{font-size:22px;font-weight:700;color:var(--accent);letter-spacing:-0.5px}.logo-sub{font-size:10px;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase}
.hbtn{display:flex;align-items:center;gap:5px;padding:6px 12px;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-family:var(--font);font-size:11px;transition:all .15s}
.hbtn:hover{border-color:var(--accent);color:var(--accent)}.hbtn svg{width:14px;height:14px}
.last-updated{font-size:10px;color:var(--text-muted);font-family:var(--mono)}
.nav{display:flex;gap:1px;padding:0 28px;background:var(--surface);border-bottom:1px solid var(--border);overflow-x:auto}
.nav-tab{padding:9px 14px;font-size:11px;font-weight:500;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all .15s}
.nav-tab:hover{color:var(--text)}.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.main{padding:20px 28px;max-width:1600px;margin:0 auto}.hidden{display:none!important}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:14px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px}
.card-label{font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);margin-bottom:2px}
.card-value{font-size:18px;font-weight:700;font-family:var(--mono)}
.card-sub{font-size:9px;color:var(--text-muted);margin-top:2px;font-family:var(--mono)}
.card-value.red{color:var(--red)}.card-value.orange{color:var(--orange)}.card-value.blue{color:var(--blue)}.card-value.green{color:var(--green)}.card-value.purple{color:var(--purple)}.card-value.teal{color:var(--teal)}
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.chart-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
.chart-box h3{font-size:10px;color:var(--accent);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
.bar-chart{display:flex;flex-direction:column;gap:4px}
.bar-row{display:flex;align-items:center;gap:5px;font-size:10px}
.bar-label{min-width:65px;text-align:right;color:var(--text-muted);font-family:var(--mono);font-size:9px;flex-shrink:0}
.bar-track{flex:1;height:16px;background:var(--surface-2);border-radius:3px;overflow:hidden}
.bar-fill{height:100%;border-radius:3px;display:flex;align-items:center;justify-content:flex-end;padding-right:4px;font-size:8px;font-family:var(--mono);color:#fff;min-width:fit-content;transition:width .4s}
.bar-val{margin-left:4px;font-family:var(--mono);font-size:9px;min-width:44px;flex-shrink:0}
.section-header{font-size:12px;font-weight:600;color:var(--accent);padding:14px 0 8px;border-bottom:1px solid var(--border);margin-bottom:10px}
.table-wrap{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:14px}
.table-scroll{overflow-x:auto;max-height:55vh;overflow-y:auto}
table{width:100%;border-collapse:collapse}
thead{position:sticky;top:0;z-index:2}
thead th{padding:7px 10px;text-align:left;font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);background:var(--surface-2);border-bottom:1px solid var(--border);white-space:nowrap}
tbody td{padding:7px 10px;border-bottom:1px solid var(--border);white-space:nowrap;font-size:11px}
tbody tr:hover{background:var(--surface-2)}
.num{font-family:var(--mono);text-align:right}
.badge{display:inline-block;padding:1px 7px;border-radius:8px;font-size:9px;font-weight:600}
.badge-green{background:var(--green-bg);color:var(--green)}.badge-red{background:var(--red-bg);color:var(--red)}
.badge-orange{background:var(--orange-bg);color:var(--orange)}.badge-blue{background:var(--blue-bg);color:var(--blue)}
.filters{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;align-items:center}
.search-input{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:6px 12px;color:var(--text);font-family:var(--font);font-size:12px;width:200px;outline:none}
.search-input:focus{border-color:var(--accent)}
.ch-pill{display:inline-block;padding:2px 8px;border-radius:4px;font-size:9px;font-weight:600;font-family:var(--mono)}
.ch-dtc{background:#d4a85325;color:var(--accent)}.ch-wholesale{background:var(--blue-bg);color:var(--blue)}
.ch-grocery{background:var(--green-bg);color:var(--green)}.ch-corporate{background:var(--purple-bg);color:var(--purple)}
.action-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:8px;display:flex;gap:14px}
.action-priority{font-size:18px;font-weight:700;font-family:var(--mono);color:var(--accent);min-width:28px}
.action-body{flex:1}.action-title{font-size:13px;font-weight:600;margin-bottom:4px}
.action-detail{font-size:11px;color:var(--text-muted);line-height:1.5}
.action-tags{display:flex;gap:6px;margin-top:6px}
.setup-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:14px;padding:32px}
.setup-screen h2{font-size:26px;color:var(--accent)}.setup-screen p{color:var(--text-muted);text-align:center;max-width:400px}
.setup-screen label{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}
.setup-screen input{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px;color:var(--text);font-family:var(--mono);font-size:13px;width:300px;text-align:center}
.setup-btn{padding:9px 28px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;font-weight:600;cursor:pointer;font-family:var(--font);font-size:13px}
.setup-error{color:var(--red);font-size:12px;display:none;text-align:center}
.loading-spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:768px){.header{padding:12px 16px}.nav{padding:0 16px}.main{padding:14px 16px}.cards{grid-template-columns:repeat(2,1fr)}.chart-row{grid-template-columns:1fr}.search-input{width:100%}}
</style>
</head>
<body>
<div id="setupScreen" class="setup-screen">
<h2>Kanel Shipping Dashboard</h2>
<p style="margin-bottom:12px">Connect to the local proxy or upload an OrderCup export file.</p>
<div style="display:flex;gap:12px;margin-bottom:16px">
<button class="setup-btn" style="flex:1" onclick="document.getElementById('fileUpload').click()">Upload XLSX / CSV</button>
<input type="file" id="fileUpload" accept=".xlsx,.csv" style="display:none" onchange="handleFileUpload(this)">
</div>
<div style="border-top:1px solid var(--border);padding-top:12px;margin-top:4px">
<p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:8px">Or connect to proxy:</p>
<label>Proxy URL</label><input type="text" id="setupUrl" value="http://localhost:3848">
<label style="margin-top:8px">Data Since</label><input type="text" id="setupSince" value="2025-09-01">
<button class="setup-btn" onclick="saveConfig()">Connect</button>
</div>
<div id="setupError" class="setup-error"></div>
</div>
<div id="app" class="hidden">
<div class="header">
<div class="header-left"><div><div class="logo">Kanel</div><div class="logo-sub">Shipping & Logistics</div></div></div>
<div class="header-right">
<span class="last-updated" id="lastUpdated"></span>
<label class="hbtn" style="cursor:pointer" title="Upload Shopify CSV for revenue/duty/tax overlay">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Shopify CSV
<input type="file" accept=".csv" style="display:none" onchange="loadShopifyCSV(this)">
</label>
<button class="hbtn" onclick="exportAllCSV()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button>
<button class="hbtn" id="refreshBtn" onclick="refreshData()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>Refresh</button>
</div></div>
<div class="nav">
<div class="nav-tab active" data-tab="overview" onclick="switchTab('overview')">Overview</div>
<div class="nav-tab" data-tab="channels" onclick="switchTab('channels')">Channels</div>
<div class="nav-tab" data-tab="monthly" onclick="switchTab('monthly')">Monthly Trends</div>
<div class="nav-tab" data-tab="geography" onclick="switchTab('geography')">Geographic</div>
<div class="nav-tab" data-tab="usintl" onclick="switchTab('usintl')">US / International</div>
<div class="nav-tab" data-tab="delivery" onclick="switchTab('delivery')">Delivery Performance</div>
<div class="nav-tab" data-tab="weight" onclick="switchTab('weight')">Weight Analysis</div>
<div class="nav-tab" data-tab="carriers" onclick="switchTab('carriers')">Carriers & Services</div>
<div class="nav-tab" data-tab="benchmarks" onclick="switchTab('benchmarks')">Benchmarks</div>
<div class="nav-tab" data-tab="actions" onclick="switchTab('actions')">Action Items</div>
<div class="nav-tab" data-tab="shipments" onclick="switchTab('shipments')">All Shipments</div>
</div>
<div class="main">
<div id="tab-overview" class="tab-content"></div>
<div id="tab-channels" class="tab-content hidden"></div>
<div id="tab-monthly" class="tab-content hidden"></div>
<div id="tab-geography" class="tab-content hidden"></div>
<div id="tab-usintl" class="tab-content hidden"></div>
<div id="tab-delivery" class="tab-content hidden"></div>
<div id="tab-weight" class="tab-content hidden"></div>
<div id="tab-carriers" class="tab-content hidden"></div>
<div id="tab-benchmarks" class="tab-content hidden"></div>
<div id="tab-actions" class="tab-content hidden"></div>
<div id="tab-shipments" class="tab-content hidden"></div>
</div></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>

// STATE
let S={config:null,raw:null,shopify:null,processed:null,shipQ:'',_c:{}};

// Reference: Freightcom costs by channel
const FREIGHTCOM={Corporate:{'2025-09':65.29,'2025-10':283.02,'2025-11':231.67,'2025-12':381.07,'2026-01':183.74},Grocery:{'2025-09':109.81,'2025-10':244.25,'2025-11':273.01,'2025-12':323.27,'2026-01':270.21},Web:{'2025-09':185.53,'2025-10':193.14,'2025-11':209.32,'2025-12':222.36,'2026-01':172.35},Wholesale:{'2025-09':2655.08,'2025-10':4225.88,'2025-11':4763.22,'2025-12':2646.34,'2026-01':2080.58}};
// Fishbowl channel revenue
const FB_CHANNELS={Grocery:{'2025-09':{orders:19,rev:21292.08},'2025-10':{orders:33,rev:73439.66},'2025-11':{orders:15,rev:26021.82},'2025-12':{orders:34,rev:61814.75},'2026-01':{orders:22,rev:17260.32}},Wholesale:{'2025-09':{orders:115,rev:212627.61},'2025-10':{orders:173,rev:409946.61},'2025-11':{orders:167,rev:292262.67},'2025-12':{orders:106,rev:181158.90},'2026-01':{orders:56,rev:108392.69}},Corporate:{'2025-09':{orders:18,rev:41640.24},'2025-10':{orders:24,rev:75876.33},'2025-11':{orders:28,rev:61947.23},'2025-12':{orders:28,rev:111773.18},'2026-01':{orders:11,rev:36054.20}}};

const MONTHS=['2025-09','2025-10','2025-11','2025-12','2026-01'];
const MONTH_LABELS=['Sep 25','Oct 25','Nov 25','Dec 25','Jan 26'];

// UTILS
const fmt=(n,d=0)=>n==null||isNaN(n)?'--':Number(n).toLocaleString('en-CA',{minimumFractionDigits:d,maximumFractionDigits:d});
const fmtD=n=>'$'+fmt(n,2);const fmtD0=n=>'$'+fmt(n,0);const fmtPct=n=>fmt(n,1)+'%';
const fmtDate=s=>{if(!s)return'--';const d=new Date(s);return isNaN(d)?'--':d.toLocaleDateString('en-CA',{month:'short',day:'numeric',year:'numeric'});};
const clr=(v,lo,hi)=>v>hi?'red':v>lo?'orange':'green';
const PROV_MAP={'QC':'QC','Quebec':'QC','ON':'ON','Ontario':'ON','BC':'BC','British Columbia':'BC','AB':'AB','Alberta':'AB','MB':'MB','Manitoba':'MB','SK':'SK','Saskatchewan':'SK','NS':'NS','Nova Scotia':'NS','NB':'NB','New Brunswick':'NB','NL':'NL','Newfoundland':'NL','PE':'PE','PEI':'PE','NT':'NT','NU':'NU','YT':'YT'};
function normProv(s){if(!s)return'Unknown';const t=s.trim();return PROV_MAP[t]||t;}
function getRegion(p){if(p==='QC')return'Quebec';if(p==='ON')return'Ontario';if(['BC','AB','SK','MB'].includes(p))return'Western';if(['NS','NB','NL','PE'].includes(p))return'Atlantic';if(['NT','NU','YT'].includes(p))return'Northern';return'Other';}
function monthKey(ds){if(!ds)return null;const d=new Date(ds);if(isNaN(d))return null;return d.getFullYear()+'-'+(''+(d.getMonth()+1)).padStart(2,'0');}
function monthLabel(mk){if(!mk)return'--';const[y,m]=mk.split('-');return['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(m)-1]+' '+y.slice(2);}
function isUSFn(prov,country){const c=(country||'').toLowerCase();if(c.includes('united states')||c==='us'||c==='usa')return true;return['NY','MA','CA','FL','TX','WA','PA','IL','OH','MI','NJ','VA','NC','GA','AZ','CO','CT','ME','VT','NH','MD','MN','OR','TN','SC','WI','IN','MO'].includes(prov);}
function totalOf(arr,key){return arr.reduce((a,b)=>a+(b[key]||0),0);}

// NAV
function switchTab(t){document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));document.querySelectorAll('.nav-tab').forEach(e=>e.classList.remove('active'));document.getElementById('tab-'+t).classList.remove('hidden');document.querySelector('.nav-tab[data-tab="'+t+'"]').classList.add('active');}

// FILE UPLOAD: OrderCup
function handleFileUpload(input){
  const file=input.files[0];if(!file)return;
  const err=document.getElementById('setupError');err.textContent='Reading file...';err.style.display='block';err.style.color='var(--text-muted)';
  const reader=new FileReader();
  reader.onload=function(e){try{
    let rows;
    if(file.name.endsWith('.csv')){const text=e.target.result;const lines=text.split('\n').filter(l=>l.trim());const headers=lines[0].split(',').map(h=>h.trim().replace(/^"|"$/g,''));rows=lines.slice(1).map(line=>{const vals=line.split(',').map(v=>v.trim().replace(/^"|"$/g,''));const obj={};headers.forEach((h,i)=>obj[h]=vals[i]||'');return obj;});}
    else{const wb=XLSX.read(e.target.result,{type:'array'});rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);}
    const shipments=rows.map(r=>({id:r.shipment_id||r.id||'',order_id:r.order_id||'',ship_date:r.ship_date||r.created_at||'',delivery_date:r.delivery_date||'',carrier:r.carrier||'',service:r.service||'',shipping_price:r.shipping_cost||r.shipping_price||0,weight:r.weight_kg||r.weight||0,length:r.length||0,width:r.width||0,height:r.height||0,item_count:r.item_count||0,item_value:r.item_value||0,ship_to_address:{state:r.ship_to_province||r.province||'',city:r.ship_to_city||r.city||'',post_code:r.ship_to_postal||'',country:r.ship_to_country||r.country||''},tracking_id:r.tracking_id||'',rsm:r.rsm||''})).filter(s=>parseFloat(s.shipping_price)>0);
    if(!shipments.length){err.style.color='var(--red)';err.textContent='No shipments found.';return;}
    S.raw={shipments,customers:[]};S.processed=processShipments(S.raw);S.config={url:'file',since:'file'};
    document.getElementById('setupScreen').classList.add('hidden');document.getElementById('app').classList.remove('hidden');
    document.getElementById('lastUpdated').textContent='File: '+file.name+' ('+shipments.length+' shp)';renderAll();
  }catch(ex){err.style.color='var(--red)';err.textContent='Error: '+ex.message;}};
  if(file.name.endsWith('.csv'))reader.readAsText(file);else reader.readAsArrayBuffer(file);input.value='';
}

// FILE UPLOAD: Shopify CSV overlay
function loadShopifyCSV(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){try{
    const lines=e.target.result.split('\n').filter(l=>l.trim());
    const headers=lines[0].split(',').map(h=>h.trim().replace(/^"|"$/g,''));
    const rows=lines.slice(1).map(line=>{const vals=[];let inQ=false,cur='';for(const ch of line){if(ch==='"'){inQ=!inQ;}else if(ch===','&&!inQ){vals.push(cur.trim());cur='';}else{cur+=ch;}}vals.push(cur.trim());const obj={};headers.forEach((h,i)=>obj[h]=vals[i]||'');return obj;});
    const monthly={};
    rows.forEach(r=>{let m;try{const dt=new Date(r.Month);m=dt.getFullYear()+'-'+(''+(dt.getMonth()+1)).padStart(2,'0');}catch{return;}if(!m||!MONTHS.includes(m))return;if(!monthly[m])monthly[m]={orders:0,gross:0,discounts:0,returns:0,net:0,shipping:0,taxes:0,duties:0,total:0,label_costs:0};monthly[m].orders++;monthly[m].gross+=parseFloat(r['Gross sales']||0);monthly[m].discounts+=Math.abs(parseFloat(r.Discounts||0));monthly[m].returns+=Math.abs(parseFloat(r.Returns||0));monthly[m].net+=parseFloat(r['Net sales']||0);monthly[m].shipping+=parseFloat(r['Shipping charges']||0);monthly[m].taxes+=parseFloat(r.Taxes||0);monthly[m].duties+=parseFloat(r.Duties||0);monthly[m].total+=parseFloat(r['Total sales']||0);monthly[m].label_costs+=parseFloat(r['Shipping label costs']||0);});
    S.shopify=monthly;if(S.processed){S.processed=processShipments(S.raw);renderAll();}
    alert('Shopify data loaded: '+rows.length+' orders across '+Object.keys(monthly).length+' months');
  }catch(ex){alert('Error: '+ex.message);}};
  reader.readAsText(file);input.value='';
}

// PROCESS SHIPMENTS
function processShipments(raw){
  const shipments=(raw.shipments||[]).map(s=>{
    const cost=parseFloat(s.shipping_price)||0;const actualWt=parseFloat(s.weight)||0;
    const l=parseFloat(s.length)||0,w=parseFloat(s.width)||0,h=parseFloat(s.height)||0;
    const dimWt=(l&&w&&h)?(l*w*h)/5000:0;const billedWt=Math.max(dimWt,actualWt);const isVol=dimWt>actualWt&&actualWt>0;
    const addr=s.ship_to_address||{};const prov=normProv(addr.state||'');const country=addr.country||'';
    const mk=monthKey(s.ship_date);const items=parseInt(s.item_count)||0;const value=parseFloat(s.item_value)||0;
    const isUS=isUSFn(prov,country);
    let delivDays=null;
    if(s.ship_date&&s.delivery_date&&String(s.delivery_date)!=='None'){try{const sd=new Date(s.ship_date),dd=new Date(s.delivery_date);const diff=(dd-sd)/(864e5);if(diff>=0&&diff<=30)delivDays=Math.round(diff);}catch{}}
    return{id:s.id||'',orderNum:s.order_id||'',shipDate:s.ship_date||'',delivDate:s.delivery_date||'',month:mk,monthLabel:monthLabel(mk),carrier:s.carrier||'Unknown',service:s.service||'Unknown',cost,actualWt,billedWt,dimWt,isVol,prov,region:getRegion(prov),country,city:addr.city||'',items,value,isUS,delivDays};
  }).filter(s=>s.cost>0).sort((a,b)=>(a.shipDate||'').localeCompare(b.shipDate||''));

  const byMonth={};
  shipments.forEach(s=>{if(!s.month)return;if(!byMonth[s.month])byMonth[s.month]={month:s.month,label:s.monthLabel,count:0,cost:0,weight:0,items:0,value:0,volCount:0,us:0,usCost:0,ca:0,caCost:0,delivTimes:[]};const m=byMonth[s.month];m.count++;m.cost+=s.cost;m.weight+=s.actualWt;m.items+=s.items;m.value+=s.value;if(s.isVol)m.volCount++;if(s.isUS){m.us++;m.usCost+=s.cost;}else{m.ca++;m.caCost+=s.cost;}if(s.delivDays!==null)m.delivTimes.push(s.delivDays);});
  const monthlyData=MONTHS.filter(m=>byMonth[m]).map(m=>{const d=byMonth[m];d.avgCost=d.count?d.cost/d.count:0;d.avgWt=d.count?d.weight/d.count:0;d.avgValue=d.count?d.value/d.count:0;d.volPct=d.count?d.volCount/d.count*100:0;d.avgDeliv=d.delivTimes.length?d.delivTimes.reduce((a,b)=>a+b,0)/d.delivTimes.length:null;d.onTime5=d.delivTimes.length?d.delivTimes.filter(t=>t<=5).length/d.delivTimes.length*100:null;return d;});

  const byProv={};
  shipments.forEach(s=>{if(!byProv[s.prov])byProv[s.prov]={prov:s.prov,region:s.region,count:0,cost:0,weight:0,delivTimes:[]};const p=byProv[s.prov];p.count++;p.cost+=s.cost;p.weight+=s.actualWt;if(s.delivDays!==null)p.delivTimes.push(s.delivDays);});
  const geoData=Object.values(byProv).sort((a,b)=>b.count-a.count).map(g=>{g.avgCost=g.count?g.cost/g.count:0;g.pct=shipments.length?g.count/shipments.length*100:0;g.avgDeliv=g.delivTimes.length?g.delivTimes.reduce((a,b)=>a+b,0)/g.delivTimes.length:null;return g;});

  const byCS={};
  shipments.forEach(s=>{const k=s.carrier+'|||'+s.service;if(!byCS[k])byCS[k]={carrier:s.carrier,service:s.service,count:0,cost:0,weight:0};const c=byCS[k];c.count++;c.cost+=s.cost;c.weight+=s.actualWt;});
  const carrierData=Object.values(byCS).sort((a,b)=>b.count-a.count).map(c=>{c.avgCost=c.count?c.cost/c.count:0;c.avgWt=c.count?c.weight/c.count:0;c.pct=shipments.length?c.count/shipments.length*100:0;return c;});

  const wBrackets=[{name:'0-0.5kg',lo:0,hi:0.5},{name:'0.5-1kg',lo:0.5,hi:1},{name:'1-1.5kg',lo:1,hi:1.5},{name:'1.5-2kg',lo:1.5,hi:2},{name:'2kg+',lo:2,hi:999}];
  const weightData=wBrackets.map(wb=>{const sub=shipments.filter(s=>s.actualWt>=wb.lo&&s.actualWt<wb.hi);const byM={};MONTHS.forEach(m=>byM[m]=sub.filter(s=>s.month===m).length);return{name:wb.name,count:sub.length,cost:sub.reduce((a,b)=>a+b.cost,0),avgCost:sub.length?sub.reduce((a,b)=>a+b.cost,0)/sub.length:0,pct:shipments.length?sub.length/shipments.length*100:0,byMonth:byM};});

  const dRanges=[{name:'Same day',lo:0,hi:0},{name:'1 day',lo:1,hi:1},{name:'2 days',lo:2,hi:2},{name:'3 days',lo:3,hi:3},{name:'4-5 days',lo:4,hi:5},{name:'6-7 days',lo:6,hi:7},{name:'8+ days',lo:8,hi:30}];
  const allDeliv=shipments.filter(s=>s.delivDays!==null);
  const delivData=dRanges.map(dr=>{const sub=allDeliv.filter(s=>s.delivDays>=dr.lo&&s.delivDays<=dr.hi);const byM={};MONTHS.forEach(m=>byM[m]=sub.filter(s=>s.month===m).length);return{name:dr.name,count:sub.length,pct:allDeliv.length?sub.length/allDeliv.length*100:0,byMonth:byM};});

  const totalCost=shipments.reduce((a,b)=>a+b.cost,0);const totalCount=shipments.length;
  const totalValue=shipments.reduce((a,b)=>a+b.value,0);
  const usCount=shipments.filter(s=>s.isUS).length;const usCost=shipments.filter(s=>s.isUS).reduce((a,b)=>a+b.cost,0);
  const allDT=shipments.filter(s=>s.delivDays!==null).map(s=>s.delivDays);

  return{shipments,monthlyData,geoData,carrierData,weightData,delivData,totals:{totalCost,totalCount,avgCost:totalCount?totalCost/totalCount:0,totalValue,avgValue:totalCount?totalValue/totalCount:0,volCount:shipments.filter(s=>s.isVol).length,volPct:totalCount?shipments.filter(s=>s.isVol).length/totalCount*100:0,usCount,usCost,caCount:totalCount-usCount,caCost:totalCost-usCost,avgActWt:totalCount?shipments.reduce((a,b)=>a+b.actualWt,0)/totalCount:0,avgDeliv:allDT.length?allDT.reduce((a,b)=>a+b,0)/allDT.length:null,onTime5:allDT.length?allDT.filter(t=>t<=5).length/allDT.length*100:null}};
}

function getChannelData(){
  const shop=S.shopify||{};const oc=S.processed?S.processed.monthlyData:[];const ocByMonth={};oc.forEach(m=>ocByMonth[m.month]=m);
  const dtc=MONTHS.map(m=>{const sh=shop[m]||{orders:0,gross:0,net:0,shipping:0,taxes:0,duties:0,label_costs:0,discounts:0};const om=ocByMonth[m]||{count:0,cost:0};const fcWeb=FREIGHTCOM.Web[m]||0;const totalShipCost=om.cost+fcWeb;return{month:m,orders:sh.orders||om.count,net:sh.net,gross:sh.gross,discounts:sh.discounts,shipCharged:sh.shipping,taxes:sh.taxes,duties:sh.duties,labelCosts:sh.label_costs,ocCost:om.cost,fcCost:fcWeb,totalShipCost,shipPct:sh.net?totalShipCost/sh.net*100:0,absorbed:totalShipCost-sh.shipping};});
  const b2b=['Grocery','Wholesale','Corporate'].map(ch=>{const rows=MONTHS.map(m=>{const fb=FB_CHANNELS[ch]?.[m]||{orders:0,rev:0};const fc=FREIGHTCOM[ch]?.[m]||0;return{month:m,orders:fb.orders,rev:fb.rev,fcCost:fc,shipPct:fb.rev?fc/fb.rev*100:0};});return{channel:ch,rows};});
  return{dtc,b2b};
}

// RENDER: OVERVIEW
function rOverview(){
  const t=S.processed.totals;const ch=getChannelData();const totalNet=totalOf(ch.dtc,'net');const b2bRev=ch.b2b.reduce((a,c)=>a+totalOf(c.rows,'rev'),0);const allRev=totalNet+b2bRev;const allFC=Object.values(FREIGHTCOM).reduce((a,ch)=>a+Object.values(ch).reduce((s,v)=>s+v,0),0);const allShipCost=t.totalCost+allFC;const shipPctRev=allRev?allShipCost/allRev*100:0;const shipCharged=totalOf(ch.dtc,'shipCharged');const netAbsorbed=allShipCost-shipCharged;
  let h='<div class="cards"><div class="card"><div class="card-label">Total Revenue (All Channels)</div><div class="card-value">'+fmtD0(allRev)+'</div><div class="card-sub">'+(S.shopify?'Shopify + Fishbowl':'Fishbowl only, upload Shopify CSV')+'</div></div><div class="card"><div class="card-label">Total Shipping Cost</div><div class="card-value red">'+fmtD0(allShipCost)+'</div><div class="card-sub">OrderCup + Freightcom</div></div><div class="card"><div class="card-label">Ship Cost % Revenue</div><div class="card-value '+clr(shipPctRev,6,10)+'">'+fmtPct(shipPctRev)+'</div><div class="card-sub">Benchmark: 8-12%</div></div><div class="card"><div class="card-label">Net Absorbed by Kanel</div><div class="card-value orange">'+fmtD0(netAbsorbed)+'</div><div class="card-sub">Cost minus charged</div></div><div class="card"><div class="card-label">DTC Shipments</div><div class="card-value">'+fmt(t.totalCount)+'</div><div class="card-sub">'+S.processed.monthlyData.length+' months</div></div><div class="card"><div class="card-label">Avg Label Cost</div><div class="card-value '+clr(t.avgCost,12,14)+'">'+fmtD(t.avgCost)+'</div><div class="card-sub">Benchmark: $8-14</div></div><div class="card"><div class="card-label">Avg Order Value</div><div class="card-value blue">'+fmtD(t.avgValue)+'</div><div class="card-sub">Label = '+(t.avgValue?fmt(t.avgCost/t.avgValue*100,1):'0')+'% of AOV</div></div><div class="card"><div class="card-label">Avg Delivery</div><div class="card-value '+(t.avgDeliv!=null&&t.avgDeliv<=3?'green':'orange')+'">'+(t.avgDeliv!=null?fmt(t.avgDeliv,1)+' days':'--')+'</div><div class="card-sub">On-time: '+(t.onTime5!=null?fmtPct(t.onTime5):'--')+'</div></div></div>';

  // Channel summary table
  h+='<div class="section-header">Revenue & Shipping by Channel</div><div class="table-wrap"><div class="table-scroll"><table><thead><tr><th>Channel</th><th>Source</th><th>Orders</th><th>Net Revenue</th><th>Ship Cost</th><th>Ship % Rev</th><th>Charged</th><th>Absorbed</th></tr></thead><tbody>';
  const dtcOrders=totalOf(ch.dtc,'orders'),dtcNet=totalNet,dtcSC=totalOf(ch.dtc,'totalShipCost');
  h+='<tr><td><span class="ch-pill ch-dtc">DTC Online</span></td><td style="color:var(--text-muted);font-size:10px">Shopify+OrderCup</td><td class="num">'+fmt(dtcOrders)+'</td><td class="num">'+fmtD0(dtcNet)+'</td><td class="num" style="font-weight:600">'+fmtD0(dtcSC)+'</td><td class="num" style="color:var(--'+(dtcNet&&dtcSC/dtcNet>.08?'orange':'green')+')">'+  (dtcNet?fmtPct(dtcSC/dtcNet*100):'--')+'</td><td class="num">'+fmtD0(shipCharged)+'</td><td class="num" style="color:var(--orange)">'+fmtD0(dtcSC-shipCharged)+'</td></tr>';
  ch.b2b.forEach(function(c){var orders=totalOf(c.rows,'orders'),rev=totalOf(c.rows,'rev'),fc=totalOf(c.rows,'fcCost');var cls=c.channel==='Wholesale'?'ch-wholesale':c.channel==='Grocery'?'ch-grocery':'ch-corporate';h+='<tr><td><span class="ch-pill '+cls+'">'+c.channel+'</span></td><td style="color:var(--text-muted);font-size:10px">Fishbowl+Freightcom</td><td class="num">'+fmt(orders)+'</td><td class="num">'+fmtD0(rev)+'</td><td class="num" style="font-weight:600">'+fmtD0(fc)+'</td><td class="num" style="color:var(--green)">'+(rev?fmtPct(fc/rev*100):'--')+'</td><td class="num">--</td><td class="num" style="color:var(--orange)">'+fmtD0(fc)+'</td></tr>';});
  h+='<tr style="background:var(--surface-2);font-weight:600"><td>TOTAL</td><td></td><td class="num">'+fmt(dtcOrders+ch.b2b.reduce(function(a,c){return a+totalOf(c.rows,'orders');},0))+'</td><td class="num">'+fmtD0(allRev)+'</td><td class="num">'+fmtD0(allShipCost)+'</td><td class="num">'+fmtPct(shipPctRev)+'</td><td class="num">'+fmtD0(shipCharged)+'</td><td class="num" style="color:var(--orange)">'+fmtD0(netAbsorbed)+'</td></tr></tbody></table></div></div>';

  // Charts
  var md=S.processed.monthlyData,maxMC=Math.max.apply(null,md.map(function(m){return m.cost;}).concat([1]));
  var geo=S.processed.geoData.slice(0,8),maxGeo=Math.max.apply(null,geo.map(function(g){return g.count;}).concat([1]));
  h+='<div class="chart-row"><div class="chart-box"><h3>Monthly DTC Label Cost</h3><div class="bar-chart">'+md.map(function(m){return'<div class="bar-row"><div class="bar-label">'+m.label+'</div><div class="bar-track"><div class="bar-fill" style="width:'+m.cost/maxMC*100+'%;background:var(--accent)">'+fmtD0(m.cost)+'</div></div><div class="bar-val">'+fmt(m.count)+' shp</div></div>';}).join('')+'</div></div><div class="chart-box"><h3>Top Destinations</h3><div class="bar-chart">'+geo.map(function(g){return'<div class="bar-row"><div class="bar-label">'+g.prov+'</div><div class="bar-track"><div class="bar-fill" style="width:'+g.count/maxGeo*100+'%;background:var(--blue)">'+fmt(g.count)+'</div></div><div class="bar-val">'+fmtPct(g.pct)+'</div></div>';}).join('')+'</div></div></div>';

  if(!S.shopify)h+='<div style="padding:12px 16px;background:var(--orange-bg);border:1px solid #e8923a40;border-radius:var(--radius);margin-bottom:14px;font-size:12px;color:var(--orange)">Upload Shopify CSV via the header button to unlock DTC revenue, taxes, duties data.</div>';
  document.getElementById('tab-overview').innerHTML=h;
}

// RENDER: CHANNELS
function rChannels(){
  var ch=getChannelData();var h='<div class="section-header">DTC Online (Shopify + OrderCup)</div><div class="table-wrap"><div class="table-scroll"><table><thead><tr><th>Metric</th>'+MONTH_LABELS.map(function(l){return'<th>'+l+'</th>';}).join('')+'<th>Total</th></tr></thead><tbody>';
  var metrics=[{l:'Orders',k:'orders',f:fmt},{l:'Gross Sales',k:'gross',f:fmtD0},{l:'Net Revenue',k:'net',f:fmtD0},{l:'Ship Charged to Customer',k:'shipCharged',f:fmtD0},{l:'OrderCup Label Costs',k:'ocCost',f:fmtD0},{l:'Freightcom (Web)',k:'fcCost',f:fmtD0},{l:'Total Shipping Cost',k:'totalShipCost',f:fmtD0,b:true},{l:'Ship % Net Revenue',k:'shipPct',f:fmtPct,b:true},{l:'Net Absorbed',k:'absorbed',f:fmtD0,b:true},{l:'Taxes Collected',k:'taxes',f:fmtD0},{l:'Duties (US/Intl)',k:'duties',f:fmtD0}];
  metrics.forEach(function(metric){var tot=metric.k==='shipPct'?(totalOf(ch.dtc,'net')?totalOf(ch.dtc,'totalShipCost')/totalOf(ch.dtc,'net')*100:0):totalOf(ch.dtc,metric.k);h+='<tr'+(metric.b?' style="font-weight:600;background:var(--surface-2)"':'')+'><td>'+metric.l+'</td>'+ch.dtc.map(function(d){return'<td class="num">'+metric.f(d[metric.k])+'</td>';}).join('')+'<td class="num" style="font-weight:700">'+metric.f(tot)+'</td></tr>';});
  h+='</tbody></table></div></div>';

  ch.b2b.forEach(function(c){var cls=c.channel==='Wholesale'?'ch-wholesale':c.channel==='Grocery'?'ch-grocery':'ch-corporate';h+='<div class="section-header"><span class="ch-pill '+cls+'">'+c.channel+'</span> (Fishbowl + Freightcom)</div><div class="table-wrap"><div class="table-scroll"><table><thead><tr><th>Metric</th>'+MONTH_LABELS.map(function(l){return'<th>'+l+'</th>';}).join('')+'<th>Total</th></tr></thead><tbody>';
    [{l:'Orders',k:'orders',f:fmt},{l:'Revenue',k:'rev',f:fmtD0},{l:'Freightcom Cost',k:'fcCost',f:fmtD0},{l:'Ship % Revenue',k:'shipPct',f:fmtPct,b:true}].forEach(function(m){var tot=m.k==='shipPct'?(totalOf(c.rows,'rev')?totalOf(c.rows,'fcCost')/totalOf(c.rows,'rev')*100:0):totalOf(c.rows,m.k);h+='<tr'+(m.b?' style="font-weight:600;background:var(--surface-2)"':'')+'><td>'+m.l+'</td>'+c.rows.map(function(r){return'<td class="num">'+m.f(r[m.k])+'</td>';}).join('')+'<td class="num" style="font-weight:700">'+m.f(tot)+'</td></tr>';});
    h+='</tbody></table></div></div>';});
  document.getElementById('tab-channels').innerHTML=h;
}

// RENDER: MONTHLY
function rMonthly(){
  var md=S.processed.monthlyData,tc=md.reduce(function(a,m){return a+m.cost;},0),tn=md.reduce(function(a,m){return a+m.count;},0);
  var h='<div class="cards"><div class="card"><div class="card-label">Months</div><div class="card-value">'+md.length+'</div></div><div class="card"><div class="card-label">Avg Monthly Cost</div><div class="card-value">'+fmtD0(tc/md.length)+'</div></div><div class="card"><div class="card-label">Avg Monthly Shipments</div><div class="card-value">'+fmt(tn/md.length)+'</div></div><div class="card"><div class="card-label">Peak Month</div><div class="card-value" style="font-size:13px">'+md.reduce(function(mx,m){return m.count>mx.count?m:mx;},{count:0}).label+'</div></div></div>';
  h+='<div class="table-wrap"><div class="table-scroll"><table><thead><tr><th>Month</th><th>Shipments</th><th>Total Cost</th><th>Avg Cost</th><th>Avg Weight</th><th>Avg AOV</th><th>Vol %</th><th>Avg Delivery</th><th>On-Time</th><th>US</th></tr></thead><tbody>';
  md.forEach(function(m){h+='<tr><td style="font-weight:600">'+m.label+'</td><td class="num">'+fmt(m.count)+'</td><td class="num" style="font-weight:600">'+fmtD0(m.cost)+'</td><td class="num" style="color:var(--'+clr(m.avgCost,12,14)+')">'+fmtD(m.avgCost)+'</td><td class="num">'+fmt(m.avgWt,2)+' kg</td><td class="num">'+fmtD(m.avgValue)+'</td><td class="num">'+fmtPct(m.volPct)+'</td><td class="num">'+(m.avgDeliv!=null?fmt(m.avgDeliv,1)+'d':'--')+'</td><td class="num" style="color:var(--'+(m.onTime5!=null&&m.onTime5>85?'green':'orange')+')">'+  (m.onTime5!=null?fmtPct(m.onTime5):'--')+'</td><td class="num">'+fmt(m.us)+'</td></tr>';});
  h+='</tbody></table></div></div>';document.getElementById('tab-monthly').innerHTML=h;
}

// RENDER: GEOGRAPHIC
function rGeo(){
  var geo=S.processed.geoData;var regions={};geo.forEach(function(g){if(!regions[g.region])regions[g.region]={region:g.region,count:0,cost:0};regions[g.region].count+=g.count;regions[g.region].cost+=g.cost;});
  var regArr=Object.values(regions).sort(function(a,b){return b.count-a.count;});var maxR=Math.max.apply(null,regArr.map(function(r){return r.count;}).concat([1]));
  var h='<div class="cards"><div class="card"><div class="card-label">Destinations</div><div class="card-value">'+geo.length+'</div></div><div class="card"><div class="card-label">#1 Province</div><div class="card-value" style="font-size:14px">'+(geo[0]?geo[0].prov+' ('+fmtPct(geo[0].pct)+')':'--')+'</div></div><div class="card"><div class="card-label">QC + ON Share</div><div class="card-value green">'+fmtPct((geo.find(function(g){return g.prov==='QC';})||{pct:0}).pct+(geo.find(function(g){return g.prov==='ON';})||{pct:0}).pct)+'</div></div></div>';
  h+='<div class="chart-row"><div class="chart-box"><h3>By Region</h3><div class="bar-chart">'+regArr.map(function(r){return'<div class="bar-row"><div class="bar-label" style="min-width:75px">'+r.region+'</div><div class="bar-track"><div class="bar-fill" style="width:'+r.count/maxR*100+'%;background:var(--blue)">'+fmt(r.count)+'</div></div><div class="bar-val">'+fmtD(r.cost/r.count)+'/shp</div></div>';}).join('')+'</div></div><div class="chart-box"><h3>Avg Cost by Region</h3><div class="bar-chart">'+regArr.map(function(r){var ac=r.cost/r.count;return'<div class="bar-row"><div class="bar-label" style="min-width:75px">'+r.region+'</div><div class="bar-track"><div class="bar-fill" style="width:'+ac/22*100+'%;background:var(--'+clr(ac,12,15)+')">'+fmtD(ac)+'</div></div><div class="bar-val">'+fmtD0(r.cost)+'</div></div>';}).join('')+'</div></div></div>';
  var zn={'QC':'Origin zone','ON':'Zone 2','BC':'Zone 4-5','AB':'Zone 4-5','MB':'Zone 3-4','SK':'Zone 3-4','NS':'Zone 3','NB':'Zone 3','NL':'Zone 4','PE':'Zone 3','YT':'Northern','NT':'Northern'};
  h+='<div class="table-wrap"><div class="table-scroll"><table><thead><tr><th>Province</th><th>Region</th><th>Shipments</th><th>%</th><th>Total Cost</th><th>Avg Cost</th><th>Avg Delivery</th><th>Zone</th></tr></thead><tbody>';
  geo.forEach(function(g){h+='<tr><td style="font-weight:600">'+g.prov+'</td><td style="color:var(--text-muted)">'+g.region+'</td><td class="num">'+fmt(g.count)+'</td><td class="num">'+fmtPct(g.pct)+'</td><td class="num">'+fmtD0(g.cost)+'</td><td class="num" style="color:var(--'+clr(g.avgCost,12,16)+')">'+fmtD(g.avgCost)+'</td><td class="num">'+(g.avgDeliv!=null?fmt(g.avgDeliv,1)+'d':'--')+'</td><td style="font-size:10px;color:var(--text-muted)">'+(zn[g.prov]||'')+'</td></tr>';});
  h+='</tbody></table></div></div>';document.getElementById('tab-geography').innerHTML=h;
}

// RENDER: US/INTL
function rUSIntl(){
  var t=S.processed.totals,md=S.processed.monthlyData,shop=S.shopify||{};
  var h='<div class="cards"><div class="card"><div class="card-label">US Shipments</div><div class="card-value purple">'+fmt(t.usCount)+'</div><div class="card-sub">'+(t.totalCount?fmtPct(t.usCount/t.totalCount*100):'0')+' of total</div></div><div class="card"><div class="card-label">US Avg Cost</div><div class="card-value">'+(t.usCount?fmtD(t.usCost/t.usCount):'--')+'</div></div><div class="card"><div class="card-label">CA Avg Cost</div><div class="card-value green">'+(t.caCount?fmtD(t.caCost/t.caCount):'--')+'</div></div><div class="card"><div class="card-label">US Premium</div><div class="card-value orange">'+(t.usCount&&t.caCount?fmtD(t.usCost/t.usCount-t.caCost/t.caCount):'--')+'</div><div class="card-sub">per parcel vs CA</div></div></div>';
  h+='<div class="section-header">Canada vs US by Month</div><div class="table-wrap"><div class="table-scroll"><table><thead><tr><th>Month</th><th>CA Shp</th><th>CA Cost</th><th>CA Avg</th><th>US Shp</th><th>US Cost</th><th>US Avg</th><th>US %</th></tr></thead><tbody>';
  md.forEach(function(m){h+='<tr><td style="font-weight:600">'+m.label+'</td><td class="num">'+fmt(m.ca)+'</td><td class="num">'+fmtD0(m.caCost)+'</td><td class="num">'+(m.ca?fmtD(m.caCost/m.ca):'--')+'</td><td class="num" style="color:var(--purple)">'+fmt(m.us)+'</td><td class="num">'+fmtD0(m.usCost)+'</td><td class="num">'+(m.us?fmtD(m.usCost/m.us):'--')+'</td><td class="num">'+(m.count?fmtPct(m.us/m.count*100):'--')+'</td></tr>';});
  h+='</tbody></table></div></div>';
  h+='<div class="section-header">Duties & Taxes (Shopify)</div>';
  if(S.shopify){h+='<div class="table-wrap"><div class="table-scroll"><table><thead><tr><th>Month</th><th>Duties</th><th>Taxes</th><th>Total</th></tr></thead><tbody>';MONTHS.forEach(function(m,i){var sh=shop[m]||{duties:0,taxes:0};h+='<tr><td style="font-weight:600">'+MONTH_LABELS[i]+'</td><td class="num" style="color:var(--purple)">'+fmtD(sh.duties)+'</td><td class="num">'+fmtD0(sh.taxes)+'</td><td class="num" style="font-weight:600">'+fmtD0(sh.duties+sh.taxes)+'</td></tr>';});h+='</tbody></table></div></div>';}
  else{h+='<div style="padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);font-size:12px;color:var(--text-muted)">Upload Shopify CSV to see duties and taxes.</div>';}
  document.getElementById('tab-usintl').innerHTML=h;
}

// RENDER: DELIVERY
function rDelivery(){
  var dd=S.processed.delivData,t=S.processed.totals,md=S.processed.monthlyData;var allDeliv=S.processed.shipments.filter(function(s){return s.delivDays!==null;});var maxD=Math.max.apply(null,dd.map(function(d){return d.count;}).concat([1]));
  var h='<div class="cards"><div class="card"><div class="card-label">Avg Delivery</div><div class="card-value '+(t.avgDeliv!=null&&t.avgDeliv<=3?'green':'orange')+'">'+(t.avgDeliv!=null?fmt(t.avgDeliv,1)+' days':'--')+'</div><div class="card-sub">Benchmark: 3-5d</div></div><div class="card"><div class="card-label">On-Time (5d)</div><div class="card-value '+(t.onTime5!=null&&t.onTime5>85?'green':'orange')+'">'+(t.onTime5!=null?fmtPct(t.onTime5):'--')+'</div><div class="card-sub">Target: 95%</div></div><div class="card"><div class="card-label">1-Day Rate</div><div class="card-value green">'+(allDeliv.length?fmtPct(allDeliv.filter(function(s){return s.delivDays<=1;}).length/allDeliv.length*100):'--')+'</div></div><div class="card"><div class="card-label">Late (8+d)</div><div class="card-value red">'+(allDeliv.length?fmtPct(allDeliv.filter(function(s){return s.delivDays>=8;}).length/allDeliv.length*100):'--')+'</div></div></div>';
  h+='<div class="chart-row"><div class="chart-box"><h3>Delivery Distribution</h3><div class="bar-chart">'+dd.map(function(d){return'<div class="bar-row"><div class="bar-label" style="min-width:70px">'+d.name+'</div><div class="bar-track"><div class="bar-fill" style="width:'+d.count/maxD*100+'%;background:var(--'+(d.name.includes('8+')?'red':d.name.includes('6-7')?'orange':'green')+')">'+fmt(d.count)+'</div></div><div class="bar-val">'+fmtPct(d.pct)+'</div></div>';}).join('')+'</div></div><div class="chart-box"><h3>On-Time by Month</h3><div class="bar-chart">'+md.map(function(m){return'<div class="bar-row"><div class="bar-label">'+m.label+'</div><div class="bar-track"><div class="bar-fill" style="width:'+(m.onTime5||0)+'%;background:var(--'+(m.onTime5>90?'green':m.onTime5>80?'blue':'orange')+')">'+  (m.onTime5!=null?fmtPct(m.onTime5):'--')+'</div></div><div class="bar-val">'+(m.avgDeliv!=null?fmt(m.avgDeliv,1)+'d':'--')+'</div></div>';}).join('')+'</div></div></div>';
  h+='<div class="table-wrap"><div class="table-scroll"><table><thead><tr><th>Days</th>'+MONTH_LABELS.map(function(l){return'<th>'+l+'</th>';}).join('')+'<th>Total</th><th>%</th></tr></thead><tbody>';
  dd.forEach(function(d){h+='<tr><td style="font-weight:600">'+d.name+'</td>'+MONTHS.map(function(m){return'<td class="num">'+fmt(d.byMonth[m]||0)+'</td>';}).join('')+'<td class="num" style="font-weight:600">'+fmt(d.count)+'</td><td class="num">'+fmtPct(d.pct)+'</td></tr>';});
  h+='</tbody></table></div></div>';document.getElementById('tab-delivery').innerHTML=h;
}

// RENDER: WEIGHT
function rWeight(){
  var wd=S.processed.weightData,t=S.processed.totals;var maxW=Math.max.apply(null,wd.map(function(w){return w.count;}).concat([1]));var bench={'0-0.5kg':9.50,'0.5-1kg':11.00,'1-1.5kg':13.50,'1.5-2kg':15.00,'2kg+':17.00};
  var h='<div class="cards"><div class="card"><div class="card-label">Avg Weight</div><div class="card-value">'+fmt(t.avgActWt,2)+' kg</div></div><div class="card"><div class="card-label">Under 1kg</div><div class="card-value green">'+fmtPct(wd.filter(function(w){return w.name.includes('0-0.5')||w.name.includes('0.5-1');}).reduce(function(a,w){return a+w.pct;},0))+'</div><div class="card-sub">Poly mailer candidates</div></div><div class="card"><div class="card-label">Volumetric %</div><div class="card-value '+  (t.volPct>30?'orange':'blue')+'">'+fmtPct(t.volPct)+'</div></div><div class="card"><div class="card-label">Label % of AOV</div><div class="card-value '+(t.avgValue&&t.avgCost/t.avgValue>.15?'red':'orange')+'">'+(t.avgValue?fmtPct(t.avgCost/t.avgValue*100):'--')+'</div></div></div>';
  h+='<div class="chart-box" style="margin-bottom:14px"><h3>Shipments by Weight</h3><div class="bar-chart">'+wd.map(function(w){return'<div class="bar-row"><div class="bar-label" style="min-width:70px">'+w.name+'</div><div class="bar-track"><div class="bar-fill" style="width:'+w.count/maxW*100+'%;background:var(--teal)">'+fmt(w.count)+'</div></div><div class="bar-val">'+fmtPct(w.pct)+'</div></div>';}).join('')+'</div></div>';
  h+='<div class="section-header">Cost by Weight vs Benchmark</div><div class="table-wrap"><div class="table-scroll"><table><thead><tr><th>Bracket</th><th>Count</th><th>%</th><th>Avg Cost</th><th>Benchmark</th><th>Gap</th>'+MONTH_LABELS.map(function(l){return'<th>'+l+'</th>';}).join('')+'</tr></thead><tbody>';
  wd.forEach(function(w){var b=bench[w.name]||0,gap=w.avgCost-b;h+='<tr><td style="font-weight:600">'+w.name+'</td><td class="num">'+fmt(w.count)+'</td><td class="num">'+fmtPct(w.pct)+'</td><td class="num" style="color:var(--'+clr(w.avgCost,b,b*1.15)+')">'+fmtD(w.avgCost)+'</td><td class="num" style="color:var(--blue)">'+fmtD(b)+'</td><td class="num" style="color:var(--'+(gap>0?'red':'green')+')">'+(gap>0?'+':'')+fmtD(gap)+'</td>'+MONTHS.map(function(m){return'<td class="num">'+fmt(w.byMonth[m]||0)+'</td>';}).join('')+'</tr>';});
  h+='</tbody></table></div></div>';document.getElementById('tab-weight').innerHTML=h;
}

// RENDER: CARRIERS
function rCarriers(){
  var cd=S.processed.carrierData,totalCost=cd.reduce(function(a,c){return a+c.cost;},0);var byC={};cd.forEach(function(c){if(!byC[c.carrier])byC[c.carrier]={carrier:c.carrier,count:0,cost:0};byC[c.carrier].count+=c.count;byC[c.carrier].cost+=c.cost;});
  var carriers=Object.values(byC).sort(function(a,b){return b.count-a.count;});var maxC=Math.max.apply(null,carriers.map(function(c){return c.count;}).concat([1]));
  var h='<div class="cards"><div class="card"><div class="card-label">Carriers</div><div class="card-value">'+carriers.length+'</div></div><div class="card"><div class="card-label">Service Levels</div><div class="card-value">'+cd.length+'</div></div><div class="card"><div class="card-label">Primary</div><div class="card-value" style="font-size:13px">'+(carriers[0]?carriers[0].carrier:'--')+'</div><div class="card-sub">'+(carriers[0]?fmtPct(carriers[0].count/S.processed.totals.totalCount*100):'')+'</div></div></div>';
  h+='<div class="chart-row"><div class="chart-box"><h3>Volume</h3><div class="bar-chart">'+carriers.map(function(c){return'<div class="bar-row"><div class="bar-label" style="min-width:90px">'+c.carrier+'</div><div class="bar-track"><div class="bar-fill" style="width:'+c.count/maxC*100+'%;background:var(--accent)">'+fmt(c.count)+'</div></div><div class="bar-val">'+fmtD(c.cost/c.count)+'/shp</div></div>';}).join('')+'</div></div><div class="chart-box"><h3>Spend</h3><div class="bar-chart">'+carriers.map(function(c){return'<div class="bar-row"><div class="bar-label" style="min-width:90px">'+c.carrier+'</div><div class="bar-track"><div class="bar-fill" style="width:'+c.cost/totalCost*100+'%;background:var(--blue)">'+fmtD0(c.cost)+'</div></div><div class="bar-val">'+fmtPct(c.cost/totalCost*100)+'</div></div>';}).join('')+'</div></div></div>';
  h+='<div class="table-wrap"><div class="table-scroll"><table><thead><tr><th>Carrier</th><th>Service</th><th>Shipments</th><th>%</th><th>Total Cost</th><th>Avg Cost</th><th>Avg Wt</th></tr></thead><tbody>';
  cd.forEach(function(c){h+='<tr><td style="font-weight:600">'+c.carrier+'</td><td style="color:var(--text-muted);font-size:10px">'+c.service+'</td><td class="num">'+fmt(c.count)+'</td><td class="num">'+fmtPct(c.pct)+'</td><td class="num">'+fmtD0(c.cost)+'</td><td class="num" style="color:var(--'+clr(c.avgCost,12,16)+')">'+fmtD(c.avgCost)+'</td><td class="num">'+fmt(c.avgWt,2)+' kg</td></tr>';});
  h+='</tbody></table></div></div>';document.getElementById('tab-carriers').innerHTML=h;
}

// RENDER: BENCHMARKS
function rBenchmarks(){
  var t=S.processed.totals,ch=getChannelData();var allRev=totalOf(ch.dtc,'net')+ch.b2b.reduce(function(a,c){return a+totalOf(c.rows,'rev');},0);var allFC=Object.values(FREIGHTCOM).reduce(function(a,ch){return a+Object.values(ch).reduce(function(s,v){return s+v;},0);},0);
  var bm=[{m:'Ship Cost % Revenue',a:allRev?(t.totalCost+allFC)/allRev*100:0,med:8,top:5,u:'%',lo:true},{m:'Label % of AOV',a:t.avgValue?t.avgCost/t.avgValue*100:0,med:12,top:8,u:'%',lo:true},{m:'Avg Cost/Parcel',a:t.avgCost,med:11.50,top:9.00,u:'$',lo:true},{m:'Avg Delivery Days',a:t.avgDeliv,med:3.5,top:2.0,u:'d',lo:true},{m:'On-Time Rate (5d)',a:t.onTime5,med:85,top:95,u:'%',lo:false},{m:'Carrier Concentration',a:S.processed.carrierData[0]?S.processed.carrierData[0].count/t.totalCount*100:0,med:70,top:50,u:'%',lo:true}];
  var h='<div class="section-header">Kanel vs Industry Benchmarks (DTC Food/CPG, &lt;1kg avg parcel)</div><div class="table-wrap"><div class="table-scroll"><table><thead><tr><th>Metric</th><th>Kanel</th><th>Median</th><th>Top 25%</th><th>Status</th><th>Notes</th></tr></thead><tbody>';
  bm.forEach(function(b){if(b.a==null)return;var status,cls;if(b.lo){if(b.a<=b.top){status='Outperforming';cls='badge-green';}else if(b.a<=b.med){status='Good';cls='badge-blue';}else{status='Above Benchmark';cls='badge-red';}}else{if(b.a>=b.top){status='Outperforming';cls='badge-green';}else if(b.a>=b.med){status='At Benchmark';cls='badge-orange';}else{status='Below';cls='badge-red';}}var fv=function(v){return b.u==='$'?fmtD(v):b.u==='d'?fmt(v,1)+'d':fmtPct(v);};h+='<tr><td style="font-weight:600">'+b.m+'</td><td class="num" style="font-weight:700">'+fv(b.a)+'</td><td class="num" style="color:var(--text-muted)">'+fv(b.med)+'</td><td class="num" style="color:var(--blue)">'+fv(b.top)+'</td><td><span class="badge '+cls+'">'+status+'</span></td><td style="font-size:10px;color:var(--text-muted)">'+(b.lo?(b.a<=b.top?'Exceeding target':'Opportunity to improve'):(b.a>=b.top?'Exceeding target':'Needs attention'))+'</td></tr>';});
  h+='</tbody></table></div></div>';document.getElementById('tab-benchmarks').innerHTML=h;
}

// RENDER: ACTIONS
function rActions(){
  var t=S.processed.totals;
  var actions=[{p:1,t:'Negotiate Canada Post Volume Discount',i:'HIGH',e:'LOW',d:fmt(t.totalCount)+' parcels, 97%+ via CP Expedited at '+fmtD(t.avgCost)+' avg. At 6,000+/yr = commercial plus pricing. Target $10.50 = $14K+ savings.',tags:['Cost','Quick Win']},{p:2,t:'Validate OrderCup vs Shopify Label Overlap',i:'HIGH',e:'LOW',d:'Both systems report label costs. Reconcile by order ID to confirm true DTC shipping cost and eliminate double-counting.',tags:['Data Quality','Quick Win']},{p:3,t:'Weight-Based Packaging SOP',i:'MED',e:'MED',d:fmtPct(S.processed.weightData[0]?S.processed.weightData[0].pct:0)+' of parcels under 0.5kg ship in 15x15x15 box. Poly mailers could save $1-2/parcel.',tags:['Cost','Operations']},{p:4,t:'Free Shipping Threshold $75',i:'HIGH',e:'LOW',d:'AOV is '+fmtD(t.avgValue)+'. A $75 threshold pushes multi-item orders while margin covers shipping.',tags:['Pricing','Revenue']},{p:5,t:'US Cross-Border Strategy',i:'MED',e:'HIGH',d:'Only '+fmt(t.usCount)+' US shipments. Enable DDP in Shopify. Negotiate Asendia/Landmark Global for $8-10 USD/parcel.',tags:['Growth','International']},{p:6,t:'Zone-Based Shipping Rates',i:'MED',e:'MED',d:'QC (49%) ships at ~$10.84 avg vs BC at ~$18.48. Variable rates by region improve margin.',tags:['Pricing','Analytics']},{p:7,t:'Wholesale Shipping Recovery',i:'HIGH',e:'LOW',d:'Wholesale shipped ~$16K via Freightcom at 1.4% of revenue. Verify if billed back or absorbed.',tags:['Cost Recovery','Quick Win']},{p:8,t:'Monthly KPI Review',i:'MED',e:'LOW',d:'Refresh monthly. Watch: ship cost % rev (<6%), avg cost (<$11), on-time (>95%).',tags:['Process']},{p:9,t:'Regular Parcel Option',i:'MED',e:'MED',d:'97.5% ships Expedited. Regular Parcel is ~30% cheaper for non-urgent orders.',tags:['Cost','Service Level']},{p:10,t:'October Data Gap',i:'HIGH',e:'LOW',d:'Oct shows 5 OrderCup shipments but 468 Shopify orders. Investigate store config or process change.',tags:['Data Quality','Urgent']},{p:11,t:'Duties/Tax Reconciliation',i:'MED',e:'MED',d:'As US volume grows, automate duty tracking to avoid chargebacks.',tags:['International']},{p:12,t:'Carrier Alternatives',i:'MED',e:'HIGH',d:'Quote Purolator Ground, ChitChats for <1kg. ChitChats targets Canadian DTC brands.',tags:['Cost','Sourcing']}];
  var h='<div class="cards"><div class="card"><div class="card-label">Actions</div><div class="card-value">'+actions.length+'</div></div><div class="card"><div class="card-label">Quick Wins</div><div class="card-value green">'+actions.filter(function(a){return a.i==='HIGH'&&a.e==='LOW';}).length+'</div></div><div class="card"><div class="card-label">Est. Annual Savings</div><div class="card-value green">$14,000+</div><div class="card-sub">CP volume alone</div></div></div>';
  actions.forEach(function(a){h+='<div class="action-card"><div class="action-priority">'+a.p+'</div><div class="action-body"><div class="action-title">'+a.t+' <span class="badge '+(a.i==='HIGH'?'badge-green':'badge-orange')+'">'+a.i+'</span> <span class="badge '+(a.e==='LOW'?'badge-green':a.e==='HIGH'?'badge-red':'badge-orange')+'">'+a.e+' effort</span></div><div class="action-detail">'+a.d+'</div><div class="action-tags">'+a.tags.map(function(t){return'<span style="font-size:9px;padding:1px 6px;border-radius:4px;background:var(--surface-3);color:var(--text-muted)">'+t+'</span>';}).join('')+'</div></div></div>';});
  document.getElementById('tab-actions').innerHTML=h;
}

// RENDER: SHIPMENTS
function rShipments(){
  var all=S.processed.shipments,d=all;
  if(S.shipQ){var q=S.shipQ.toLowerCase();d=d.filter(function(s){return(s.orderNum+s.carrier+s.service+s.prov+s.city).toLowerCase().indexOf(q)>=0;});}
  S._c.shipmentsF=d;
  var h='<div class="filters"><input type="text" class="search-input" placeholder="Search..." oninput="S.shipQ=this.value;rShipments()" value="'+S.shipQ+'"><span class="result-count" style="margin-left:8px">'+fmt(d.length)+' shipments</span><button class="hbtn" style="margin-left:auto" onclick="exportShipCSV()">Export CSV</button></div>';
  h+='<div class="table-wrap"><div class="table-scroll"><table><thead><tr><th>Order</th><th>Date</th><th>Carrier</th><th>Service</th><th>Cost</th><th>Wt</th><th>DIM</th><th>Items</th><th>Value</th><th>Prov</th><th>City</th><th>Deliv</th></tr></thead><tbody>';
  var show=d.slice(-500).reverse();
  show.forEach(function(s){h+='<tr><td style="font-family:var(--mono);font-size:10px">'+s.orderNum+'</td><td style="font-size:10px">'+fmtDate(s.shipDate)+'</td><td>'+s.carrier+'</td><td style="font-size:10px;color:var(--text-muted)">'+s.service+'</td><td class="num" style="font-weight:600">'+fmtD(s.cost)+'</td><td class="num">'+fmt(s.actualWt,2)+'</td><td>'+(s.isVol?'<span style="color:var(--orange);font-size:9px">DIM</span>':'')+'</td><td class="num">'+(s.items||'--')+'</td><td class="num">'+(s.value?fmtD(s.value):'--')+'</td><td>'+(s.isUS?'<span style="color:var(--purple)">'+s.prov+'</span>':s.prov)+'</td><td style="font-size:10px;color:var(--text-muted)">'+s.city+'</td><td class="num">'+(s.delivDays!=null?s.delivDays+'d':'--')+'</td></tr>';});
  if(d.length>500)h+='<tr><td colspan="12" style="text-align:center;color:var(--text-muted);padding:14px">Showing 500 of '+fmt(d.length)+'</td></tr>';
  h+='</tbody></table></div></div>';document.getElementById('tab-shipments').innerHTML=h;
}

// EXPORTS
function exportShipCSV(){var d=S._c.shipmentsF||S.processed.shipments;var rows=[['Order','Date','Carrier','Service','Cost','Weight','Items','Value','Province','City','Country','US','DelivDays','Tracking']];d.forEach(function(s){rows.push([s.orderNum,s.shipDate,s.carrier,s.service,s.cost,s.actualWt,s.items,s.value,s.prov,s.city,s.country,s.isUS?'Y':'N',s.delivDays!=null?s.delivDays:'',s.tracking]);});dlCSV(rows,'Kanel_Shipments.csv');}
function exportAllCSV(){var rows=[['Month','Shipments','Cost','AvgCost','AvgWt','AvgAOV','Vol%','AvgDeliv','OnTime%','US']];S.processed.monthlyData.forEach(function(m){rows.push([m.label,m.count,m.cost.toFixed(2),m.avgCost.toFixed(2),m.avgWt.toFixed(2),m.avgValue.toFixed(2),m.volPct.toFixed(1),m.avgDeliv!=null?m.avgDeliv.toFixed(1):'',m.onTime5!=null?m.onTime5.toFixed(1):'',m.us]);});dlCSV(rows,'Kanel_Monthly.csv');}
function dlCSV(rows,fn){var csv=rows.map(function(r){return r.map(function(c){return'"'+String(c).replace(/"/g,'""')+'"';}).join(',');}).join('\n');var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download=fn;a.click();}

// RENDER ALL
function renderAll(){if(!S.processed)return;rOverview();rChannels();rMonthly();rGeo();rUSIntl();rDelivery();rWeight();rCarriers();rBenchmarks();rActions();rShipments();}

// CONNECTION
function saveConfig(){var url=document.getElementById('setupUrl').value.trim().replace(/\/$/,''),since=document.getElementById('setupSince').value.trim();var err=document.getElementById('setupError');if(!url){err.textContent='URL required';err.style.display='block';return;}err.textContent='Connecting...';err.style.display='block';err.style.color='var(--text-muted)';fetch(url+'/api/health').then(function(r){if(!r.ok)throw new Error('HTTP '+r.status);return r.json();}).then(function(d){if(d.status!=='ok')throw new Error('Bad response');S.config={url:url,since:since||'2025-09-01'};localStorage.setItem('ks-cfg',JSON.stringify(S.config));document.getElementById('setupScreen').classList.add('hidden');document.getElementById('app').classList.remove('hidden');refreshData();}).catch(function(e){err.style.color='var(--red)';err.textContent='Failed: '+e.message;});}

function refreshData(){var btn=document.getElementById('refreshBtn');btn.disabled=true;btn.innerHTML='<div class="loading-spinner" style="width:14px;height:14px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:4px"></div>Loading...';fetch(S.config.url+'/api/shipping-data?since='+S.config.since).then(function(r){if(!r.ok)throw new Error('HTTP '+r.status);return r.json();}).then(function(data){S.raw=data;S.processed=processShipments(S.raw);document.getElementById('lastUpdated').textContent='Updated '+new Date().toLocaleString('en-CA',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})+' | '+fmt(S.processed.totals.totalCount)+' shp';renderAll();}).catch(function(e){alert('Failed: '+e.message);}).finally(function(){btn.disabled=false;btn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" style="width:14px;height:14px"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>Refresh';});}

function loadConfig(){var saved=localStorage.getItem('ks-cfg');if(saved){try{S.config=JSON.parse(saved);document.getElementById('setupScreen').classList.add('hidden');document.getElementById('app').classList.remove('hidden');refreshData();}catch(e){localStorage.removeItem('ks-cfg');}}}
loadConfig();


</script>
</body>
</html>